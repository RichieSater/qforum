<!DOCTYPE html>
<html>
<head>
<link href='i1.wp.com' rel='dns-prefetch'>
<link href='i2.wp.com' rel='dns-prefetch'>
<link href='i3.wp.com' rel='dns-prefetch'>
<meta content='2HgX9mcLHaPOX6sfaaAkhWtblhEB9yUNw4l6l46e1k4' name='google-site-verification'>
<link rel="shortcut icon" type="image/x-icon" href="external/favicon-q-ac1a76f2c200e9026b5b1147519bb4fab6256910588b831e2411bc6c7c1218c3.png" />
<title>
Function: returns() not behaving as expected
</title>
<meta content='Hello Quants,I am still very new and have been working on a few algorithms simply to better understand the system. I&#39;m stuck on a strange problem. The algorithm is a bulked up momentum script:First, I define an (arbitrary) selection of stocks and the %s at which buy/sell actions should take place. The first time it runs (when the portfolio is empty), it will take half the cash available and distribute it evenly among the stocks.Next, it sells all stocks that have gone up in value by a certain...' name='description'>
<link rel="stylesheet" media="all" href="external/quanto-base-bundle-e8eb6050172aa0d24124d5c24bac90b2cccd88b5b9c7742026c0e9efab038c6e.css" />
<link rel="stylesheet" media="all" href="external/quanto-posts-bundle-aab01368d3f82d8dafc94ee9eabb82e77dc8c9fbbffa952fdcdc744dfa523cf3.css" />
<script src="external/quanto_global-057218867db29d5768131af5d6fb3476cef098e7d9e655108befb903c7ee985e.js"></script>
<script src="external/posts_bundle-3dfd82fa469c393d752e461d837aec9e4e364ae39f49198e34a6626f2180fdf7.js"></script>
<link href='external/logo-q-180x180-0f5a6a439c99203ed4aea6f656e7604c543d287be43d8b17c7591c1131f09a59.png' rel='apple-touch-icon'>
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="tpoij8GPgiW7tjOFXqh0cm6yafQgpJUKTH1hEZ82JknK/FTCY3lQxgKrarQRR9wGVjxKnVpogBHOcrp7NXNE8g==" />
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<script>
//<![CDATA[
window.quanto_data={};quanto_data.bounce_back_params={"show_modal":null,"feedback_text":null};quanto_data.namespace="public";quanto_data.talib_info={"ADOSC":["Chaikin A/D Oscillator (Volume Indicators)",["fastperiod","3"],["slowperiod","10"]],"ADX":["Average Directional Movement Index (Momentum Indicators)",["timeperiod","14"]],"ADXR":["Average Directional Movement Index Rating (Momentum Indicators)",["timeperiod","14"]],"APO":["Absolute Price Oscillator (Momentum Indicators)",["fastperiod","12"],["slowperiod","26"],["matype","0"]],"AROON":["Aroon (Momentum Indicators)",["timeperiod","14"]],"AROONOSC":["Aroon Oscillator (Momentum Indicators)",["timeperiod","14"]],"ATR":["Average True Range (Volatility Indicators)",["timeperiod","14"]],"BBANDS":["Bollinger Bands (Overlap Studies)",["timeperiod","5"],["nbdevup","2"],["nbdevdn","2"],["matype","0"]],"BETA":["Beta (Statistic Functions)",["timeperiod","5"]],"CCI":["Commodity Channel Index (Momentum Indicators)",["timeperiod","14"]],"CMO":["Chande Momentum Oscillator (Momentum Indicators)",["timeperiod","14"]],"CORREL":["Pearson's Correlation Coefficient (r) (Statistic Functions)",["timeperiod","30"]],"DEMA":["Double Exponential Moving Average (Overlap Studies)",["timeperiod","30"]],"DX":["Average Directional Movement Index (Momentum Indicators)",["timeperiod","14"]],"EMA":["Exponential Moving Average (Overlap Studies)",["timeperiod","30"]],"KAMA":["Kaufman Adaptive Moving Average (Overlap Studies)",["timeperiod","30"]],"LINEARREG":["Linear Regression (Statistic Functions)",["timeperiod","14"]],"LINEARREG_ANGLE":["Linear Regression Angle (Statistic Functions)",["timeperiod","14"]],"LINEARREG_INTERCEPT":["Linear Regression Intercept (Statistic Functions)",["timeperiod","14"]],"LINEARREG_SLOPE":["Linear Regression Slope (Statistic Functions)",["timeperiod","14"]],"MA":["Moving average (Overlap Studies)",["timeperiod","30"],["matype","0"]],"MACD":["Moving Average Convergence/Divergence (Momentum Indicators)",["fastperiod","12"],["slowperiod","26"],["signalperiod","9"]],"MACDEXT":["MACD with controllable MA type (Momentum Indicators)",["fastperiod","12"],["fastmatype","0"],["slowperiod","26"],["slowmatype","0"],["signalperiod","9"],["signalmatype","0"]],"MACDFIX":["Moving Average Convergence/Divergence Fix 12/26 (Momentum Indicators)",["signalperiod","9"]],"MAX":["Highest values over a specified period (Math Operators)",["timeperiod","30"]],"MAXINDEX":["Index of highest value over a specified period (Math Operators)",["timeperiod","30"]],"MFI":["Money Flow Index (Momentum Indicators)",["timeperiod","14"]],"MIDPOINT":["Midpoint over period (Overlap Studies)",["timeperiod","14"]],"MIDPRICE":["Midpoint Price over period (Overlap Studies)",["timeperiod","14"]],"MIN":["Lowest value over a specified period (Math Operators)",["timeperiod","30"]],"MININDEX":["Index of lowest value over a specified period (Math Operators)",["timeperiod","30"]],"MINMAX":["Lowest and highest values over a specified period (Math Operators)",["timeperiod","30"]],"MINMAXINDEX":["Indexes of lowest and highest values over a specified period (Math Operators)",["timeperiod","30"]],"MINUS_DI":["Minus Directional Indicator (Momentum Indicators)",["timeperiod","14"]],"MINUS_DM":["Minus Directional Movement (Momentum Indicators)",["timeperiod","14"]],"MOM":["Momentum (Momentum Indicators)",["timeperiod","10"]],"NATR":["Normalized Average True Range (Volatility Indicators)",["timeperiod","14"]],"PLUS_DI":["Plus Directional Indicator (Momentum Indicators)",["timeperiod","14"]],"PLUS_DM":["Plus Directional Movement (Momentum Indicators)",["timeperiod","14"]],"PPO":["Percentage Price Oscillator (Momentum Indicators)",["fastperiod","12"],["slowperiod","26"],["matype","0"]],"ROC":["Rate of change: ((price/prevPrice)-1)*100 (Momentum Indicators)",["timeperiod","10"]],"ROCP":["Rate of change Percentage: (price-prevPrice)/prevPrice (Momentum Indicators)",["timeperiod","10"]],"ROCR":["Rate of change ratio: (price/prevPrice) (Momentum Indicators)",["timeperiod","10"]],"ROCR100":["Rate of change ratio 100 scale: (price/prevPrice)*100 (Momentum Indicators)",["timeperiod","10"]],"RSI":["Relative Strength Index (Momentum Indicators)",["timeperiod","14"]],"SMA":["Simple Moving Average (Overlap Studies)",["timeperiod","30"]],"STDDEV":["Standard Deviation (Statistic Functions)",["timeperiod","5"],["nbdev","1"]],"STOCH":["Stochastic (Momentum Indicators)",["fastk_period","5"],["slowk_period","3"],["slowk_matype","0"],["slowd_period","3"],["slowd_matype","0"]],"STOCHF":["Stochastic Fast (Momentum Indicators)",["fastk_period","5"],["fastd_period","3"],["fastd_matype","0"]],"STOCHRSI":["Stochastic Relative Strength Index (Momentum Indicators)",["timeperiod","14"],["fastk_period","5"],["fastd_period","3"],["fastd_matype","0"]],"T3":["Triple Exponential Moving Average (T3) (Overlap Studies)",["timeperiod","5"],["vfactor","0.7"]],"TEMA":["Triple Exponential Moving Average (Overlap Studies)",["timeperiod","30"]],"TRIMA":["Triangular Moving Average (Overlap Studies)",["timeperiod","30"]],"TRIX":["1-day Rate-Of-Change (ROC) of a Triple Smooth EMA (Momentum Indicators)",["timeperiod","30"]],"TSF":["Time Series Forecast (Statistic Functions)",["timeperiod","14"]],"ULTOSC":["Ultimate Oscillator (Momentum Indicators)",["timeperiod1","7"],["timeperiod2","14"],["timeperiod3","28"]],"VAR":["Variance (Statistic Functions)",["timeperiod","5"],["nbdev","1"]],"WILLR":["Williams' %R (Momentum Indicators)",["timeperiod","14"]],"WMA":["Weighted Moving Average (Overlap Studies)",["timeperiod","30"]]};quanto_data.nb_preview_url="https://notebooks-preview.prd.pub.quantopian.com";quanto_data.delay_nb_preview_load=false;
//]]>
</script>
<meta content='https://www.quantopian.com/posts/function-returns-not-behaving-as-expected' property='og:url'>
<meta content='Function: returns() not behaving as expected' property='og:title'>

<input type="hidden" name="env" id="quanto-env" value="production" />
<meta content='550580758292093' property='fb:app_id'>
<meta content='https://www.quantopian.com/posts/function-returns-not-behaving-as-expected' property='og:url'>
<meta content='https://media.quantopian.com/public/og-image-default.png' property='og:image'>
<meta content='Function: returns() not behaving as expected' property='og:title'>
<meta content='Hello Quants,I am still very new and have been working on a few algorithms simply to better understand the system. I&#39;m stuck on a strange problem. The algorithm is a bulked up momentum script:First, I define an (arbitrary) selection of stocks and the %s at which buy/sell actions should take place. The first time it runs (when the portfolio is empty), it will take half the cash available and distribute it evenly among the stocks.Next, it sells all stocks that have gone up in value by a certain...' property='og:description'>
</head>
<script type='application/ld+json'>
  {
    "@context": "http://schema.org",
    "@type": "Organization",
    "url": "https://www.quantopian.com",
    "logo": "https://media.quantopian.com/logos/logo-q-press-red.png"
  }
</script>
<body class='' ontouchstart=''>
<div id='fb-root'></div>
<div class='wrapper'>
<div class='alert-v2 error'>
<div class='message'>
Quantopian's community platform is shutting down. Please read <a href="/posts/quantopians-community-services-are-closing">this post</a> for more information and <a href='/account#account'>download your code</a>.
</div>
</div>
<div class='navbar navbar-default navbar-static-top' id='app-navbar'>
<div class='container-fluid'>
<div class='navbar-header'>
<button class='navbar-toggle collapsed' data-target='#app-navbar-collapse' data-toggle='collapse'>
<span class='icon hamburger-menu'></span>
</button>
<a class='navbar-brand' href='/home'>
<img class='logo-image async-image' data-src='external/logo-q-white-b141ea6018546e5a4ecc3d10d8440ec076fc4385764e948b322828cc70950a76.svg'>
</a>
</div>
<div class='collapse navbar-collapse' id='app-navbar-collapse'>
<ul class='nav navbar-nav navbar-right'>
<li class='dropdown quanto-dropdown-new'>
<li>
<a class='header' href='/docs'>
Documentation
</a>
</li>
<li class='dropdown quanto-dropdown-new'>
<a class='header' data-toggle='dropdown' href='#'>
Learn
</a>
<ul class='dropdown-menu'>
<li>
<a class='mixpanel-button' data-event='main nav getting started clicked' href='/tutorials/getting-started'>Getting Started</a>
</li>
<li>
<a class='mixpanel-button' data-event='main nav tutorials clicked' href='/tutorials'>Tutorials</a>
</li>
<li>
<a class='mixpanel-button' data-event='main nav lectures clicked' href='/lectures'>Lectures</a>
</li>
</ul>
</li>
<li>
<a class='header' href='/posts' id='forum-link'>
Forum
</a>
</li>
<li>
<a class="header" href="/signin?return_to=/posts/function-returns-not-behaving-as-expected">Log In</a>
</li>
</li>

</ul>
</div>
</div>
</div>
<script>
  $(document).ready(function () {
    quanto.instances.fm = new quanto.FeedbackManager();
    quanto.instances.hm = new quanto.headerManager();
  })
</script>


<div class='content content-area new-style'>
<input type="hidden" name="page-id" id="page-id" value="postatomic" />
<script src="external/MathJax.js?config=TeX-AMS_HTML-full.js,Safe" async="async"></script>
<div class='container page-container post-atomic'>
<input id='parent-post-id-val' type='hidden' value='554ebbf30c99b6ddda0004a6'>
<div class='post-container' data-post-id='554ebbf30c99b6ddda0004a6' id='554ebbf30c99b6ddda0004a6'>
<div class='back-button back-to-community'>Back to Community</div>
<div class='post-title'>Function: returns() not behaving as expected</div>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/553bfa64db90459d9500079d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/7d058674e0e533a63cfe815ae12cde59?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/553bfa64db90459d9500079d'>Matthew Canning</a>
</div>
<span class='posted-at'>posted </span>
<span UTCms='1431223283000' class='quanto-date posted-at'></span>
<div class='pull-right other-actions'>
<div class='dropup inline-block'>
<div class='dropdown share-control other-action-link'>
<div data-toggle='dropdown'>
<div class='share-image'></div>
Share
</div>
<ul class='dropdown-menu share-options-menu'>
<li>
<a class='share-row' href='https://twitter.com/intent/tweet?text=Function: returns() not behaving as expected&amp;url=https%3A%2F%2Fwww.quantopian.com%2Fposts%2Ffunction-returns-not-behaving-as-expected%3Futm_source%3Dwebsite_share%26utm_campaign%3Dfunction-returns-not-behaving-as-expected%26utm_medium%3Dtwitter&amp;via=quantopian'>
<i class='icon icon-twitter'></i>
Share on Twitter
</a>
</li>
<li>
<div class='share-row facebook-button'>
<i class='icon icon-facebook'></i>
Share on Facebook
</div>
</li>
<li>
<div class='share-row linkedin-button' data-share-url='https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fwww.quantopian.com%2Fposts%2Ffunction-returns-not-behaving-as-expected%3Futm_source%3Dwebsite_share%26utm_campaign%3Dfunction-returns-not-behaving-as-expected%26utm_medium%3Dlinkedin&amp;title=Function%3A+returns%28%29+not+behaving+as+expected+%28Matthew+Canning%29&amp;source=Quantopian'>
<i class='icon icon-linkedin'></i>
Share on LinkedIn
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>

<input type="hidden" name="social_fb_post_link" id="social_fb_post_link" value="https://www.quantopian.com/posts/function-returns-not-behaving-as-expected?utm_source=website_share&amp;utm_campaign=function-returns-not-behaving-as-expected&amp;utm_medium=facebook" />
<input type="hidden" name="social_post_image" id="social_post_image" value="external/logo-q-red-outline.png" />
<input type="hidden" name="social_post_author" id="social_post_author" value="Matthew Canning" />
<div class='body-text'>
<div class='body-text-container post-body'><p>Hello Quants,</p>

<p>I am still very new and have been working on a few algorithms simply to better understand the system. I&#39;m stuck on a strange problem. The algorithm is a bulked up momentum script:</p>

<p>First, I define an (arbitrary) selection of stocks and the %s at which buy/sell actions should take place. The first time it runs (when the portfolio is empty), it will take half the cash available and distribute it evenly among the stocks.</p>

<p>Next, it sells all stocks that have gone up in value by a certain % (defined by <strong>returns()</strong>), and then buys all stocks (that I don&#39;t already hold) that have gone down by a certain % (also defined by <strong>returns())</strong>. Instead of splitting available cash evenly among these stocks, I create a &quot;buy curve&quot; which favors the stocks with the most &quot;middle of the road&quot; returns (but that still fall within the &quot;buy&quot; threshold) and buys less of those that barely make the cut or have dropped too much.</p>

<p>However, when I was running it daily, I was seeing things like this: </p>

<p><strong>4/27</strong><br>
Buy EROC: 34 shares @ $2.55. Total: $86.70<br>
Buy LLNW: 23 shares @ $3.76. Total: $86.48</p>

<p><strong>4/28</strong><br>
Sell EROC: 34 shares @ $2.45. Total: ($83.30)<br>
Sell LLNW: 23 shares @ $3.68. Total: ($84.64)</p>

<p>It&#39;s selling when the price has dropped.</p>

<p><strong>returns()</strong>, according to the documentation, is the % gain/lost in the last day. However, the <strong>returns()</strong> for these securities are positive on 4/28, even though their prices were lower when the orders took place.</p>

<p>I want this to run once daily, but to troubleshoot, I ran it in minute mode (but then had to add line 56, which skips that minute if there are still open orders; this should in theory only run through sell and buy functions when all orders have settled, thus preventing duplicate sells and buys). Same problem.</p>

<p>What am I missing? I am simply trying to say, &quot;if the price went up x% since yesterday, sell. If it went down y% since yesterday, buy.&quot; <strong>returns()</strong> doesn&#39;t seem to provide a reliable way to do this. </p>

<p>Thanks in advance. This community has been incredibly helpful throughout my first few weeks here and I hope to be able to return the favor soon.  </p>
</div>
</div>
</div>

</div>

<div class='container page-container post-atomic'>
<div class='section-header reply-header'>
<div class='reply-title'>16 responses</div>
</div>
<div class='replies'>
<div class='post-container response-container' data-post-id='554ff97dddaeef6cac0002f5' id='554ff97dddaeef6cac0002f5'>
<a href='#554ff97dddaeef6cac0002f5'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/518adef0ac9d8e67a000000a'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/2114608fe0c1969868c3db6b76e511d1?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/518adef0ac9d8e67a000000a'>Michael Van Kleeck</a>
</div>
<a UTCms='1431304576000' class='quanto-date posted-at response-posted-at' href='#554ff97dddaeef6cac0002f5'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>In daily mode, your order is executed at the next day&#39;s closing price.  Your code doesn&#39;t include the logging that generated the output in your post, but I suspect that the prices that look wrong to you are the prices on the order date and (one day later) the execution date.  In other words, you&#39;re probably looking at returns on the day <em>after</em> you place your order, whereas you made your buy/sell decision based on the returns on the day of your order.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='55502b3c69ae988fc700040f' id='55502b3c69ae988fc700040f'>
<a href='#55502b3c69ae988fc700040f'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/553bfa64db90459d9500079d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/7d058674e0e533a63cfe815ae12cde59?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/553bfa64db90459d9500079d'>Matthew Canning</a>
</div>
<a UTCms='1431317311000' class='quanto-date posted-at response-posted-at' href='#55502b3c69ae988fc700040f'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks Michael. Is there any reliable way to solve this and actually compare current price to yesterday&#39;s at the same time of day?</p>

<p>And, just to understand better, is returns() buffering by a day due to system restrictions or purposely (for a  purpose I&#39;m simply missing)? Thanks!  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5550a65cde4994596500061e' id='5550a65cde4994596500061e'>
<a href='#5550a65cde4994596500061e'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/5445095923fba7c7730002ec'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/bff7bb2005dfba5cba38b364b1033bd5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/5445095923fba7c7730002ec'>Gregory Milne</a>
</div>
<a UTCms='1431348831000' class='quanto-date posted-at response-posted-at' href='#5550a65cde4994596500061e'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>If you use </p>

<pre><code>prices = history(2, &#39;1d&#39;, &#39;close_price&#39;)  
</code></pre>

<p>prices[0] = yesterday close<br>
prices[1] = In minute mode, this will change to the most recent price for a given security per bar (aka per each handle_data() execution).</p>

<p>Could you elaborate on &quot;actually compare current price to yesterday&#39;s at the same time of day?&quot; ?</p>

<p>I may be able to help, just need some more clarification from you.</p>

<p>Greg  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5550b1bcab5683bc1c000016' id='5550b1bcab5683bc1c000016'>
<a href='#5550b1bcab5683bc1c000016'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/553bfa64db90459d9500079d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/7d058674e0e533a63cfe815ae12cde59?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/553bfa64db90459d9500079d'>Matthew Canning</a>
</div>
<a UTCms='1431351742000' class='quanto-date posted-at response-posted-at' href='#5550b1bcab5683bc1c000016'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks Greg,</p>

<p>Yes, I originally tried using history but then switched to returns() because I thought it was providing a simpler way to get the same thing (I was incorrect). I can&#39;t seem to find how to apply history() to a specific security, but I may just be missing it in the API docs. I&#39;ll look further.</p>

<p>It seems like your solution will work for me...if it will compare yesterday&#39;s close to the most recent price available. That functionality will negate my need for any sort of &quot;same time of day&quot; comparison.</p>

<p>I&#39;ll give it a shot. Thanks!  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5550c1241c51f36a8f00000a' id='5550c1241c51f36a8f00000a'>
<a href='#5550c1241c51f36a8f00000a'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/52b9b56c02cabe5dae000143'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/e9388ae5102f3b152fa6225f955a29d4?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/52b9b56c02cabe5dae000143'>Alisa Deychman</a>
<img class='quantopian-badge async-image' data-src='https://qf.quantopian.com/assets/logos/staff-q-red-stroke-095008cf53acafb1da63369cad14e3083d49d13eea83f592dd3dd0d5f0474fcc.svg'>
</div>
<a UTCms='1431355687000' class='quanto-date posted-at response-posted-at' href='#5550c1241c51f36a8f00000a'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>To apply history for a specific stock, you can use panda&#39;s indexing: <a href="http://pandas.pydata.org/pandas-docs/stable/indexing.html">http://pandas.pydata.org/pandas-docs/stable/indexing.html</a></p>

<p>Using Greg&#39;s example to get AAPL&#39;s prices, </p>

<pre><code>prices_aapl = history(2, &#39;1d&#39;, &#39;close_price&#39;)[symbol(&#39;AAPL&#39;)]  
</code></pre>
</div>
<div class='disclaimer-minimized-wrapper'>
<div class='title'>Disclaimer</div>
<div class='disclaimer'>
<p>
The material on this website is provided for informational purposes only and does not constitute an offer to sell, a solicitation to buy, or a recommendation or endorsement for any security or strategy, nor does it constitute an offer to provide investment advisory services by Quantopian. In addition, the material offers no opinion with respect to the suitability of any security or specific investment. No information contained herein should be regarded as a suggestion to engage in or refrain from any investment-related course of action as none of Quantopian nor any of its affiliates is undertaking to provide investment advice, act as an adviser to any plan or entity subject to the Employee Retirement Income Security Act of 1974, as amended, individual retirement account or individual retirement annuity, or give advice in a fiduciary capacity with respect to the materials presented herein.  If you are an individual retirement or other investor, contact your financial advisor or other fiduciary unrelated to Quantopian about whether any given investment idea, strategy, product or service described herein may be appropriate for your circumstances.  All investments involve risk, including loss of principal.  Quantopian makes no guarantees as to the accuracy or completeness of the views expressed in the website. The views are subject to change, and may have become unreliable for various reasons, including changes in market conditions or economic circumstances.
</p>
</div>
</div>

</div>
</div>

<div class='post-container response-container' data-post-id='5550c81df18c7bf9100000a0' id='5550c81df18c7bf9100000a0'>
<a href='#5550c81df18c7bf9100000a0'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/553bfa64db90459d9500079d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/7d058674e0e533a63cfe815ae12cde59?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/553bfa64db90459d9500079d'>Matthew Canning</a>
</div>
<a UTCms='1431357471000' class='quanto-date posted-at response-posted-at' href='#5550c81df18c7bf9100000a0'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks Alisa! Perfect solution.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='55512689ed49ac9c93000100' id='55512689ed49ac9c93000100'>
<a href='#55512689ed49ac9c93000100'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/518adef0ac9d8e67a000000a'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/2114608fe0c1969868c3db6b76e511d1?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/518adef0ac9d8e67a000000a'>Michael Van Kleeck</a>
</div>
<a UTCms='1431381645000' class='quanto-date posted-at response-posted-at' href='#55512689ed49ac9c93000100'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>To compare yesterday&#39;s close to the most recent price available, you can use either returns() or the prices from history().  The attached backtest uses both methods, and they give identical results (the first % in each line is from returns(), the second uses prices from history()):</p>

<pre><code>2015-01-13handle_data:28INFO2015-01-13 14:00 AAPL 110.021,  0.7% [ 109.26 -> 110.021:  0.7%]  
2015-01-13handle_data:28INFO2015-01-13 15:00 AAPL  109.74,  0.4% [ 109.26 ->  109.74:  0.4%]  
2015-01-13handle_data:28INFO2015-01-13 16:00 AAPL 110.225,  0.9% [ 109.26 -> 110.225:  0.9%]  
2015-01-14handle_data:28INFO2015-01-14 14:00 AAPL 108.927, -1.2% [110.225 -> 108.927: -1.2%]  
2015-01-14handle_data:28INFO2015-01-14 15:00 AAPL 109.091, -1.0% [110.225 -> 109.091: -1.0%]  
2015-01-14handle_data:28INFO2015-01-14 16:00 AAPL  109.79, -0.4% [110.225 ->  109.79: -0.4%]  
2015-01-15handle_data:28INFO2015-01-15 14:00 AAPL   107.1, -2.5% [ 109.79 ->   107.1: -2.5%]  
2015-01-15handle_data:28INFO2015-01-15 15:00 AAPL  107.75, -1.9% [ 109.79 ->  107.75: -1.9%]  
2015-01-15handle_data:28INFO2015-01-15 16:00 AAPL  106.83, -2.7% [ 109.79 ->  106.83: -2.7%]  
</code></pre>

<p>Whichever method you use, remember that if you run in daily mode, your order won&#39;t execute until the next day -- and the returns for that day will be different from the returns on the day you decided to place your order.  So if I understand your intent correctly, you&#39;ll probably want to run in minute mode.  Then if you examine returns and place an order before market close, the order will usually execute one minute later.  Instead of a full day&#39;s delay, you&#39;ll only have one minute delay and not much change in returns.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='555205623c7ea864a70000db' id='555205623c7ea864a70000db'>
<a href='#555205623c7ea864a70000db'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/553bfa64db90459d9500079d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/7d058674e0e533a63cfe815ae12cde59?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/553bfa64db90459d9500079d'>Matthew Canning</a>
</div>
<a UTCms='1431438695000' class='quanto-date posted-at response-posted-at' href='#555205623c7ea864a70000db'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks Michael. That makes sense.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5552310f07123e200b0001f9' id='5552310f07123e200b0001f9'>
<a href='#5552310f07123e200b0001f9'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/5550f7cdab5683bc1c000170'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/9d8d82773f7e6fcfb873c61a906dbec4?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/5550f7cdab5683bc1c000170'>Timothy Reed</a>
</div>
<a UTCms='1431449874000' class='quanto-date posted-at response-posted-at' href='#5552310f07123e200b0001f9'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Matthew I to am new to Quantopian and I found reading through you code very helpful to my understanding, and after looking at you initial_portfolio_population function I did one change to how it buys stocks initially, and then ran the same Backtest you did which had an interesting result, all I did was have the program only buy stocks if they are lower than usual a.k.a buy low sell high. and had a large difference in performance. As a *new user I would like to know why that happened. </p>

<p>*Quantopian user for two-three days  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='555232e35af47c52410001f8' id='555232e35af47c52410001f8'>
<a href='#555232e35af47c52410001f8'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/553bfa64db90459d9500079d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/7d058674e0e533a63cfe815ae12cde59?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/553bfa64db90459d9500079d'>Matthew Canning</a>
</div>
<a UTCms='1431450341000' class='quanto-date posted-at response-posted-at' href='#555232e35af47c52410001f8'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Hi Tim. I haven&#39;t messed with mavg() yet but I see your point in making sure to avoid buying in a peak by pure chance. I&#39;ll try it out. Thanks!  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='555233a207123e200b000209' id='555233a207123e200b000209'>
<a href='#555233a207123e200b000209'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/5550f7cdab5683bc1c000170'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/9d8d82773f7e6fcfb873c61a906dbec4?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/5550f7cdab5683bc1c000170'>Timothy Reed</a>
</div>
<a UTCms='1431450532000' class='quanto-date posted-at response-posted-at' href='#555233a207123e200b000209'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>No Problem actually I should thank you, I learned a great amount about Quantopian because of just reading through this and testing new things out.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='55523494c4b238fb42000237' id='55523494c4b238fb42000237'>
<a href='#55523494c4b238fb42000237'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/553bfa64db90459d9500079d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/7d058674e0e533a63cfe815ae12cde59?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/553bfa64db90459d9500079d'>Matthew Canning</a>
</div>
<a UTCms='1431450776000' class='quanto-date posted-at response-posted-at' href='#55523494c4b238fb42000237'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Glad I could help, though I&#39;m brand new myself. Hey, a thought--the way you had it avoid high priced stocks happens after establishing the amount of money to dedicate to each stock. If you set that logic earlier, you&#39;ll be in a better place to distribute properly. Something like this:</p>

<pre><code>        # Figure out how much money you&#39;re dedicating to each stock  
        buy_count = 0  
        for this_stock in context.stocks_allowed:  
            this_stocks_data = data[this_stock]  
            # Make sure not to buy at the stock&#39;s peak  
            average_price = this_stocks_data.mavg(2)  
            if average_price &gt; this_stocks_data.price:  
                buy_count = buy_count + 1

        # Buy an equal amount of each stock  
        amount_per_stock = (context.portfolio.cash * (float(context.initial_buy_pct) * 0.01)) / buy_count  
        for this_stock in context.stocks_allowed:  
            this_stocks_data = data[this_stock]  
            average_price = this_stocks_data.mavg(2)  
            if average_price &gt; this_stocks_data.price:  
                num_of_shares = math.floor(amount_per_stock / this_stocks_data.price)  
                order(this_stock, +num_of_shares)  
</code></pre>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='55523a275af47c91e50001b5' id='55523a275af47c91e50001b5'>
<a href='#55523a275af47c91e50001b5'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/5550f7cdab5683bc1c000170'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/9d8d82773f7e6fcfb873c61a906dbec4?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/5550f7cdab5683bc1c000170'>Timothy Reed</a>
</div>
<a UTCms='1431452201000' class='quanto-date posted-at response-posted-at' href='#55523a275af47c91e50001b5'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>that is very interesting, I am working on a version now. were would this go? Because I wiped the initial_portfolio_population function and put this in but when I ran a back test it tanked, something like -3,000 percent so I get the concept and am working on a version but how do I incorporate this specifically, or is this just and example of a possibility  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='55523e1fc4b238e4c2000281' id='55523e1fc4b238e4c2000281'>
<a href='#55523e1fc4b238e4c2000281'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/553bfa64db90459d9500079d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/7d058674e0e533a63cfe815ae12cde59?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/553bfa64db90459d9500079d'>Matthew Canning</a>
</div>
<a UTCms='1431453217000' class='quanto-date posted-at response-posted-at' href='#55523e1fc4b238e4c2000281'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>I edited the above to correct a mistake. I&#39;m just taking what you did and figuring out the $ amount to dedicate to each stock beforehand. See below for it in context.</p>

<pre><code>import math

##################################################################################  
##################################################################################

def initialize(context):

    # Define all stocks involved in this algorithm (by sid)  
    context.stocks_allowed = [sid(22418), sid(45620), sid(39227), sid(21481), sid(29686), sid(14596), sid(21413), sid(15306), sid(2214), sid(32331), sid(32781), sid(21203), sid(21724), sid(677), sid(33989), sid(34443), sid(18184), sid(41522)]

    # This determines whether this is the first time these stocks have been purchased  
    context.initial_purchase_flag = 0

    # This array stores the returns of each stock to purchase as well as the symbol of each. It is used to determine the volume of each stock to buy  
    context.curve_index = []

    # The min amount of settled cash available to allow stock purchases to take place  
    context.min_account_balance_to_buy = 1000

    # Of all the stocks purchased, what pct (total) do you want to decrease the volume of?  
    context.exterior_pct_to_deprioritize = 40

    # How drastic is the difference between the prioritized and deprioritized stocks?  
    context.curve_delta_pct = 80

    # How much of total cash should be used to buy stocks upon first load  
    context.initial_buy_pct = 50

    # No point in applying a curve to a few stocks. Define a min number to apply a curve to.  
    context.min_num_of_stocks_to_curve = 5  
    # Define notional limits  
    context.max_notional = 1000000.1  
    context.min_notional = -1000000.0

    # Not yet implemented: num of days after which to sell a stock that&#39;s been sitting in your portfolio, regardless of performance  
    context.age_out_days = 5 

    # Define the criteria by which the algorithm will purchase or sell a given security (% of change up/down)  
    context.pct_change_to_sell = 0.5  
    context.pct_change_to_buy = 0.5

    # Define the % by which a stock would have to decrease in order to &quot;cut losses&quot; and sell it (to avoid total loss from a diving stock)  
    context.max_decrease_pct = 4

    # Don&#39;t fully understand this, but was told to do this in order to get &quot;yesterday&#39;s closing price&quot; for a given security  
    set_universe(universe.DollarVolumeUniverse(90.0, 90.1))

##################################################################################  
##################################################################################

# handle_data broken into a series of synchronous functions  
def handle_data(context, data):  
    # Only execute trades if there are currently no open orders  
    if not get_open_orders():  
        initial_portfolio_population(context, data)  
        sell_stocks(context, data)  
        buy_stocks(context, data)

##################################################################################  
##################################################################################

def initial_portfolio_population(context, data):  
    if len(context.portfolio.positions) == 0:  
        # Make sure you don&#39;t immediately sell these by accident  
        context.initial_purchase_flag = 1

        # Figure out how much money you&#39;re dedicating to each stock  
        buy_count = 0  
        for this_stock in context.stocks_allowed:  
            this_stocks_data = data[this_stock]  
            # Make sure not to buy at the stock&#39;s peak  
            average_price = this_stocks_data.mavg(2)  
            if average_price &gt; this_stocks_data.price:  
                buy_count = buy_count + 1

        # Buy an equal amount of each stock  
        amount_per_stock = (context.portfolio.cash * (float(context.initial_buy_pct) * 0.01)) / buy_count  
        for this_stock in context.stocks_allowed:  
            this_stocks_data = data[this_stock]  
            average_price = this_stocks_data.mavg(2)  
            if average_price &gt; this_stocks_data.price:  
                num_of_shares = math.floor(amount_per_stock / this_stocks_data.price)  
                order(this_stock, +num_of_shares)

##################################################################################  
##################################################################################

def sell_stocks(context, data):

    # First, ensure that the portfolio contains one or more securities (otherwise, there&#39;s nothing to sell and this function becomes pointless)  
    if (len(context.portfolio.positions) != 0) and (context.initial_purchase_flag == 0) and not get_open_orders():

        stocks_to_sell = []

        for this_stock in context.portfolio.positions:  
            # prices[0] is yesterday&#39;s close; prices[1] the most recent price for a given security per bar (aka per each handle_data() execution).  
            prices = history(2, &#39;1d&#39;, &#39;close_price&#39;)[this_stock]  
            price_diff = prices[1] - prices[0]  
            price_diff_perc = float(price_diff / prices[0])

            # If it&#39;s increased in value enough, sell all shares (haven&#39;t yet added &quot;age out&quot; logic (context.age_out_days))  
            if (price_diff_perc &gt; 0) and (price_diff_perc &gt; (float(context.pct_change_to_sell) * 0.01)):  
                stocks_to_sell.append(this_stock)

        # Then actually sell them. You can&#39;t sell them inside the above loop because the dictionary size will change and error out.  
        for this_stock in stocks_to_sell:  
            order_target(this_stock, 0)

##################################################################################  
##################################################################################

def buy_stocks(context, data):

    if (context.initial_purchase_flag == 0) and (context.portfolio.cash &gt; context.min_account_balance_to_buy) and not get_open_orders():

        # Establish list of stocks to purchase  
        stocks_to_purchase = []

        # Go through the allowed stocks list and determine which meet the criteria (which ones have decreased in price today)  
        for this_stock in context.stocks_allowed:  
            this_stocks_data = data[this_stock]  
            # prices[0] is yesterday&#39;s close; prices[1] the most recent price for a given security per bar (aka per each handle_data() execution).  
            prices = history(2, &#39;1d&#39;, &#39;close_price&#39;)[this_stock]  
            price_diff = prices[1] - prices[0]  
            price_diff_perc = float(price_diff / prices[0])  
            if (price_diff_perc &lt; 0) and (price_diff_perc &lt; (float(context.pct_change_to_buy) * 0.01)) and (this_stock not in context.portfolio.positions):  
                # Don&#39;t buy anything that has dropped more than cmax_decrease_pct (avoiding diving stocks)  
                if (price_diff_perc &gt; (0 - (float(context.max_decrease_pct) * 0.01))):  
                    stocks_to_purchase.append(this_stock)  
                    context.curve_index.append([price_diff_perc, this_stock.symbol])

        # Proceed with purchase logic if there&#39;s anything to purchase  
        if (len(stocks_to_purchase) != 0):

            # TO DO: Add logic here to randomly strip away number of stocks to purchase if there are too many  
            # Determine curve:  
            curve_nums = create_buy_curve(stocks_to_purchase, context)

            # Actually purchase the stocks  
            wallet_snapshot = context.portfolio.cash  
            i = 0  
            for this_stock in stocks_to_purchase:  
                this_stocks_data = data[this_stock]  
                num_of_shares = math.floor((wallet_snapshot * (curve_nums[i] * 0.01)) / this_stocks_data.price)  
                order(this_stock, +num_of_shares)  
                i = i + 1

    else:  
        context.initial_purchase_flag = 0

##################################################################################  
##################################################################################

def create_buy_curve(stocks_to_purchase, context):  
    context.stocks_to_purchase_sorted = []  
    context.curve_index_sorted = []

    # Sorting curve_index based on returns  
    context.curve_index_sorted = sorted(context.curve_index, key=lambda x: x[0])

    # Then go through each of the sorted indexes  
    for index in context.curve_index_sorted:  
        for this_stock in stocks_to_purchase:  
          if this_stock.symbol == index[1]:  
               context.stocks_to_purchase_sorted.append(this_stock)

    # You now have context.stocks_to_purchase_sorted. Time to figure out the num of stocks and develop a curve based on that  
    curve_nums = []

    total_num_of_stocks_to_purchase = len(context.stocks_to_purchase_sorted)  
    if (total_num_of_stocks_to_purchase != 0) and (total_num_of_stocks_to_purchase &gt; context.min_num_of_stocks_to_curve):  
        # Determine respective %s  
        num_of_stocks_at_beginning_and_end_to_deprioritize = int(math.floor(((context.exterior_pct_to_deprioritize * 0.01) / 2) * total_num_of_stocks_to_purchase))  
        num_of_stocks_in_middle_to_prioritize = int(total_num_of_stocks_to_purchase - (num_of_stocks_at_beginning_and_end_to_deprioritize * 2))  
        smaller_pct = int(((100 - context.curve_delta_pct) * 0.01) * (100 / (num_of_stocks_at_beginning_and_end_to_deprioritize * 2)))  
        larger_pct = int((context.curve_delta_pct * 0.01) * (100 / num_of_stocks_in_middle_to_prioritize))

        for i in range(num_of_stocks_at_beginning_and_end_to_deprioritize):  
            curve_nums.append(smaller_pct)  
        for i in range(num_of_stocks_in_middle_to_prioritize):  
            curve_nums.append(larger_pct)  
        for i in range(num_of_stocks_at_beginning_and_end_to_deprioritize):  
            curve_nums.append(smaller_pct)

    else:  
        for this_stock in context.stocks_to_purchase_sorted:  
            simple_pct = math.floor(len(context.stocks_to_purchase_sorted) / total_num_of_stocks_to_purchase)  
            curve_nums.append(simple_pct)

    return curve_nums

##################################################################################  
##################################################################################

</code></pre>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='55523f3c07123e200b000230' id='55523f3c07123e200b000230'>
<a href='#55523f3c07123e200b000230'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/5550f7cdab5683bc1c000170'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/9d8d82773f7e6fcfb873c61a906dbec4?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/5550f7cdab5683bc1c000170'>Timothy Reed</a>
</div>
<a UTCms='1431453506000' class='quanto-date posted-at response-posted-at' href='#55523f3c07123e200b000230'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>okay how does this run? would be interesting to see, you gave me an Idea I am working on a version that the lower the stock the more money it will invest into that stock aka, one stock is 4$ below average and one is 2 dollars below average invest more proportionally to the one 4 under average  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='555247ba77f60f7e8800020c' id='555247ba77f60f7e8800020c'>
<a href='#555247ba77f60f7e8800020c'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/553bfa64db90459d9500079d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/7d058674e0e533a63cfe815ae12cde59?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/553bfa64db90459d9500079d'>Matthew Canning</a>
</div>
<a UTCms='1431455676000' class='quanto-date posted-at response-posted-at' href='#555247ba77f60f7e8800020c'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>It performs poorly, to say the least haha. I&#39;m going to work to refine it into something potentially usable once I fix all the problems I&#39;m facing. </p>

<p>I&#39;m using history to compare previous close to current and it&#39;s still buying after prices dropped, so I need to spend some time stepping through the breakpoints to determine how that&#39;s happening.  </p>
</div>
</div>
</div>

</div>
<div class='sign-in-please'>
Please <a href='/signin?return_to=/posts/function-returns-not-behaving-as-expected'>sign in</a> or
<a href='/users/sign_up?redirect_to=/posts/function-returns-not-behaving-as-expected'>join Quantopian</a> to
post a reply.
</div>
</div>
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId: "550580758292093",
      status: false,
      cookie: true,
      xfbml: true
    });
  };
  
  (function(d, debug){
    var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement('script'); js.id = id; js.async = true;
    js.src = "//connect.facebook.net/en_US/all" + (debug ? "/debug" : "") + ".js";
    ref.parentNode.insertBefore(js, ref);
  }(document, /*debug*/ false));
  
  window.twttr = (function (d,s,id) {
    var t, js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return; js=d.createElement(s); js.id=id;
    js.src="//platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs);
    return window.twttr || (t = { _e: [], ready: function(f){ t._e.push(f) } });
  }(document, "script", "twitter-wjs"));
</script>
<script>
  $(document).ready(function () {
    quanto.instances.pm = new quanto.PostManager(false)
  });
</script>

<div class='login-footer'>
<div class='container'>
<div class='login-footer-text'>
Become an expert in quant finance through Quantopian's hands-on education.
</div>
<div class='login-footer-button'>
<button class='btn btn-v2 stroke join-modal-link mixpanel-button' data-event='anon join footer click posts' data-mixpanel='click'>
Join Now
</button>
</div>
</div>
</div>

<div class='fade modal quanto-modal-v2' id='error-modal' role='dialog' tabindex='-1'>
<div class='modal-dialog' role='document'>
<div class='modal-content'>
<div class='modal-header'>
<span class='title modal-title'>Error</span>
</div>
<div class='modal-body body-content'>
<p>Sorry, something went wrong.  Try again or contact us by <a class='feedback-link'>sending feedback</a>.</p>
</div>
<div class='modal-footer'>
<button class='btn btn-v2 blue action-button' data-dismiss='modal' href='#'>Close</button>
</div>

</div>
</div>
</div>

<div class='fade modal quanto-modal-v2' id='confirmation-modal' role='dialog' tabindex='-1'>
<div class='modal-dialog' role='document'>
<div class='modal-content'>
<div class='modal-header'>
<span class='title modal-title'></span>
</div>
<div class='modal-body body-content'></div>
<div class='modal-footer'>
<div class='pull-right'>
<button class='btn btn-v2 border' data-dismiss='modal'>Cancel</button>
<button class='btn btn-v2 blue action-button' data-dismiss='modal'></button>
</div>
</div>

</div>
</div>
</div>

<div class='fade modal quanto-modal-v2' id='message-modal' role='dialog' tabindex='-1'>
<div class='modal-dialog' role='document'>
<div class='modal-content'>
<div class='modal-header'>
<span class='title modal-title'></span>
</div>
<div class='modal-body body-content'></div>
<div class='modal-footer'>
<button class='btn btn-v2 blue action-button' data-dismiss='modal' id='message-modal-close'>Close</button>
</div>

</div>
</div>
</div>

<div class='always-bootstrap3-modals'>
<div class='fade modal quanto-modal-v2' id='join-modal' role='dialog' tabindex='-1'>
<div class='modal-dialog' role='document'>
<div class='modal-content'>
<div class='modal-header visible-small'>
<span class='title'>
Join Quantopian.  It's Free!
</span>
<div class='modal-x-out visible-xs'></div>
</div>
<div class='modal-body'>
<div class='flex-wrap'>
<div class='join-left-pane hidden-small'>
<div class='margin_30l'>
<div class='join-hero-text'>
Join Quantopian.  It's Free!
</div>
<div class='join-benefits'>
<div class='join-benefit'>
<div class='join-image-container'>
<div class='join-image code'></div>
</div>
<div class='join-text'>
Use our research platform, backtester, and dozens of clean data sets.
</div>
</div>
<div class='join-benefit'>
<div class='join-image-container'>
<div class='join-image learn'></div>
</div>
<div class='join-text'>
Learn with our hands-on education and community forums.
</div>
</div>
<div class='join-benefit'>
<div class='join-image-container'>
<div class='join-image win'></div>
</div>
<div class='join-text'>
Enter to win cash prizes in our contest.
</div>
</div>
</div>
<div class='hidden saved-reminder'>
Don't worry, all your work is already saved.
</div>
</div>
</div>
<div class='join-right-pane'>
<div class='hidden-small'>
<div class='button-pane'>
<a class="button btn-v2 user-form-btn" href="/signin">Already a Quantopian member?</a>
</div>
</div>
<div class='visible-small'>
<div class='already-member'>
<a href='/signin'>Already a Quantopian member?</a>
</div>
</div>
<form class="quanto-form-v2" id="new-user-modal-form" action="/users" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><div class='error-message hidden'>
<div class='message'></div>
</div>
<div class='name-group'>
<div class='form-group inline-block'>
<label for="user_firstname">First Name</label>
<input class="form-control firstname" pattern=".*" required="required" autocomplete="off" autofocus="autofocus" type="text" name="user[firstname]" id="user_firstname" />
</div>
<div class='form-group inline-block'>
<label for="user_lastname">Last Name</label>
<input class="form-control" value="" pattern=".*" required="required" autocomplete="off" type="text" name="user[lastname]" id="user_lastname" />
</div>
</div>
<div class='form-group'>
<label for="user_email">Email</label>
<input class="form-control" value="" pattern=".*" required="required" autocomplete="off" type="email" name="user[email]" id="user_email" />
</div>
<div class='form-group'>
<label for="user_password">Password</label>
<input autocomplete="off" class="form-control" pattern=".*" required="required" type="password" name="user[password]" id="user_password" />
</div>
<div class='checkbox eula'>
<input id='eula-checkbox' type='checkbox'>
<div class='quanto-checkbox'></div>
<label for='eula-checkbox' id='checkbox-label'>I accept the <a href='/policies/terms' target='_blank'>Terms Of Use</a> and <a href='/policies/privacy' target='_blank'>Privacy Policy</a>.</label>
</div>
<div class='checkbox mailchimp-box'>
<input name="user[allow_marketing_emails]" type="hidden" value="0" /><input type="checkbox" value="1" name="user[allow_marketing_emails]" id="user_allow_marketing_emails" />
<div class='quanto-checkbox'></div>
<label for='user_allow_marketing_emails'>
Send me email updates with the latest news from the Quantopian community. We send these emails about once a month.
</label>
</div>
<div class='button-row'>
<button class='btn-v2 blue full' data-redirect-to='/tutorials/getting-started' id='sign-up-button' type='Submit'>Join Quantopian</button>
</div>
</form></div>
</div>
</div>

</div>
</div>
</div>

<div class='fade modal quanto-modal-v2' id='feedback-modal' role='dialog' tabindex='-1'>
<div class='modal-dialog' role='document'>
<div class='modal-content'>
<div class='modal-header'>
<span class='title'>Contact Support</span>
</div>
<div class='modal-body'>
<form class='anon-user controls quanto-form-v2' id='feedback-form'>
<div class='feedback-inputs'>
<div class='form-group'>
<input autofocus class='form-control' id='feedback-email-box' name='email' placeholder='Email Address' type='email'>
</div>
<div class='form-group'>
<input class='form-control' id='feedback-name-box' placeholder='Name' type='name'>
</div>
<div class='form-group'>
<textarea class='form-control' id='feedback-box' name='feedback' placeholder='What may we help you with?' rows='10'></textarea>
</div>
</div>
</form>
<form class='hidden quanto-form-v2 select-resource-area'>
<div class='select-step select-type-step'>
<div class='form-group'>
<select class='form-control select-resource-dropdown' title='Select the item you need help with'>
<option value='algorithm'>Algorithm</option>
<option value='backtest'>Backtest</option>
<option value='notebook'>Notebook</option>
</select>
</div>
</div>
<div class='select-step loading-area hidden'>
<div class='loading-text'>
Loading...
</div>
</div>
<div class='select-step empty-list-area hidden'>
<div class='back-button'>Go Back</div>
<div class='empty-text'>
No <span class='empty-list-resource-text'>algorithms</span> found
</div>
</div>
<div class='select-algo-area select-step hidden'>
<div class='back-button'>Go Back</div>
<table class='select-algo-table select-item-table'>
<thead>
<tr>
<th>
Algorithm
<span class='sort-icon'></span>
</th>
<th>
Last Modified
<span class='sort-icon'></span>
</th>
</tr>
</thead>
</table>
</div>
<div class='select-backtest-area select-step hidden'>
<div class='back-button'>Go Back</div>
<table class='select-backtest-table select-item-table'>
<thead>
<tr>
<th>
Backtest
<span class='sort-icon'></span>
</th>
<th>
Started At
<span class='sort-icon'></span>
</th>
<th>
Overall Return
<span class='sort-icon'></span>
</th>
<th>
Status
<span class='sort-icon'></span>
</th>
</tr>
</thead>
</table>
</div>
<div class='select-notebook-area select-step hidden'>
<div class='back-button'>Go Back</div>
<div class='subtitle select-cell-step'>
Choose a cell to use as the preview for this notebook:
</div>
<div class='iframe-wrapper'>
<iframe class='notebook-list-iframe slow-fade' src=''></iframe>
</div>
<div class='progress-area slow-fade in'>
<div class='progress-container'>
<div class='progress-title'>
<div class='quanto-loader gray'></div>
</div>
</div>
</div>
<div class='maintenance-area'>
<div class='error-container'>
<div class='row'>
<div class='col-md-14 msg-title h1'>
Sorry, research is currently undergoing maintenance.
</div>
</div>
<div class='row'>
<div class='col-md-14 msg-subtitle'>
Please check back shortly. If the maintenance period lasts longer than expected,
you can find updates on <a href='https://status.quantopian.com/'>status.quantopian.com</a>.
</div>
</div>

</div>
</div>
<div class='error-area'>
<div class='error-container'>
<div class='row'>
<div class='col-md-14 msg-title h1'>
Sorry, something went wrong on our end.
</div>
</div>
<div class='row'>
<div class='col-md-14 msg-subtitle'>
Please try again or contact <a class='open-feedback-link'>Quantopian support</a>.
</div>
</div>

</div>
</div>

</div>
<div class='selected-item-area select-step hidden'>
<div class='selected-item-group form-group'>
<div class='selected-item-control'>
<input class='disabled form-control selected-item-box' type='text'>
<span class='secure-icon icon'></span>
<button class='btn change change-primary-item-button change-selection-button new-btn transparent' type='button'>
<span class='refresh-icon icon'></span>
</button>
</div>
<div class='selected-backtest-control'>
<input class='disabled form-control selected-backtest-box' type='text'>
<span class='secure-icon icon'></span>
<button class='btn change-backtest-button change-selection-button new-btn transparent' type='button'>
<span class='refresh-icon icon'></span>
</button>
</div>
</div>
<div class='checkbox-group form-group'>
<div class='checkbox give-permission'>
<input class='give-permission-checkbox' id='feedback-give-permission-checkbox' type='checkbox'>
<div class='quanto-checkbox'></div>
<label for='feedback-give-permission-checkbox'>
I permit Quantopian to view <span class='item-type-text'>this algorithm,
backtest or notebook and their imported datasets</span> for the purpose of providing support.
</label>
</div>
</div>
</div>
</form>

<div class='loading-step hidden'>
<div class='loading-text'>
Submitting your support ticket...
</div>
</div>
<div class='success-step invisible'>
<h2 class='title center'>
You've successfully submitted a support ticket.
</h2>
<p>
Our support team will be in touch soon.
</p>
<div class='confirmation-image'></div>
</div>
</div>
<div class='modal-footer'>
<button class='btn-v2 blue' id='send-feedback-button'>Send</button>
<div class='error-message hidden'>
Error submitting support request.
</div>
</div>

</div>
</div>
</div>

</div>
</div>
<div class='footer' id='quanto-footer-container'>
<div class='container'>
<div class='row header-row'>
<div class='col-sm-fourth span3'>
<img class='async-image logotype-image' data-src='https://qf.quantopian.com/assets/logos/logo-q-full-b23bda5ac757691b9259d396d0dfef91567165868b8c955a836649686e6d2248.svg'>
</div>
<div class='col-sm-fourth span3'></div>
<div class='col-sm-fourth span3'></div>
<div class='col-sm-fourth span3'>
<div class='feedback-email'>
Need help?
<a href="/cdn-cgi/l/email-protection#f89e9d9d9c9a999b93b8898d99968c9788919996d69b9795">Contact support.</a>
</div>
</div>
</div>
<div class='row'>
<div class='col-sm-fourth span3'>
<div class='header'>Company</div>
<div class='footer-row'>
<a href='/about'>About</a>
</div>
<div class='footer-row'>
<a href='/academia'>Academia</a>
</div>
<div class='footer-row'>
<a href='/jobs'>Careers</a>
</div>
<div class='footer-row'>
<a href='/posts'>Community</a>
</div>
<div class='footer-row'>
<a href='/events'>Events</a>
</div>
</div>
<div class='col-sm-fourth span3'>
<div class='header'>Learn &amp; Support</div>
<div class='footer-row'>
<a href='/faq'>FAQ</a>
</div>
<div class='footer-row'>
<a href='/tutorials/getting-started'>Getting Started</a>
</div>
<div class='footer-row'>
<a href='/docs'>Documentation</a>
</div>
<div class='footer-row'>
<a href='/tutorials'>Tutorials</a>
</div>
<div class='footer-row'>
<a href='/lectures'>Lectures</a>
</div>
<div class='footer-row'>
<a href='/opensource'>Open Source</a>
</div>
<div class='footer-row'>
<a href='https://status.quantopian.com/'>Site Status</a>
</div>
</div>
<div class='col-sm-fourth span3'>
<div class='header'>Notices</div>
<div class='footer-row'>
<a href='/policies/terms'>Terms of Use</a>
</div>
<div class='footer-row'>
<a href='/policies/privacy'>Privacy Policy</a>
</div>
<div class='footer-row'>
<a href='/security'>Security</a>
</div>
<div class='footer-row'>
<a href='/policies/code-of-conduct'>Code of Conduct</a>
</div>
</div>
<div class='col-sm-fourth span3'>
<div class='header'>Follow Us</div>
<div class='footer-row'>
<a href='https://www.twitter.com/quantopian'>Twitter</a>
</div>
<div class='footer-row'>
<a href='https://www.facebook.com/quantopian'>Facebook</a>
</div>
<div class='footer-row'>
<a href='https://www.linkedin.com/company/quantopian'>LinkedIn</a>
</div>
<div class='footer-row'>
<a href='https://www.youtube.com/channel/UC606MUq45P3zFLa4VGKbxsg'>YouTube</a>
</div>
</div>
</div>
<div class='row'>
<div class='col-xs-14 span12'>
<div class='disclaimer'>
<p>
The material on this website is provided for informational purposes only and does not constitute an offer to sell, a solicitation to buy, or a recommendation or endorsement for any security or strategy, nor does it constitute an offer to provide investment advisory services by Quantopian.
</p>
<p>
In addition, the material offers no opinion with respect to the suitability of any security or specific investment. No information contained herein should be regarded as a suggestion to engage in or refrain from any investment-related course of action as none of Quantopian nor any of its affiliates is undertaking to provide investment advice, act as an adviser to any plan or entity subject to the Employee Retirement Income Security Act of 1974, as amended, individual retirement account or individual retirement annuity, or give advice in a fiduciary capacity with respect to the materials presented herein.  If you are an individual retirement or other investor, contact your financial advisor or other fiduciary unrelated to Quantopian about whether any given investment idea, strategy, product or service described herein may be appropriate for your circumstances.  All investments involve risk, including loss of principal.  Quantopian makes no guarantees as to the accuracy or completeness of the views expressed in the website. The views are subject to change, and may have become unreliable for various reasons, including changes in market conditions or economic circumstances.
</p>

</div>
</div>
</div>
</div>
</div>
<div class='mobile-footer'>
<div class='mobile-nav-category main-links'>
<div class='mobile-nav-row-footer'>
<a href='/about'>About Quantopian</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/jobs'>Careers</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/posts'>Community</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/events'>Events</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/docs'>Documentation</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/academia'>Academia</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/lectures'>Lectures</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='https://status.quantopian.com/'>Status</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='https://www.facebook.com/quantopian'>Facebook</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='https://www.twitter.com/quantopian'>Twitter</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='https://www.linkedin.com/company/quantopian'>LinkedIn</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='https://www.youtube.com/channel/UC606MUq45P3zFLa4VGKbxsg'>YouTube</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/policies/terms'>Terms of Use</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/policies/privacy'>Privacy Policy</a>
</div>
</div>
<div class='mobile-nav-category'>
<div class='disclaimer'>
<p>
The material on this website is provided for informational purposes only and does not constitute an offer to sell, a solicitation to buy, or a recommendation or endorsement for any security or strategy, nor does it constitute an offer to provide investment advisory services by Quantopian.
</p>
<p>
In addition, the material offers no opinion with respect to the suitability of any security or specific investment. No information contained herein should be regarded as a suggestion to engage in or refrain from any investment-related course of action as none of Quantopian nor any of its affiliates is undertaking to provide investment advice, act as an adviser to any plan or entity subject to the Employee Retirement Income Security Act of 1974, as amended, individual retirement account or individual retirement annuity, or give advice in a fiduciary capacity with respect to the materials presented herein.  If you are an individual retirement or other investor, contact your financial advisor or other fiduciary unrelated to Quantopian about whether any given investment idea, strategy, product or service described herein may be appropriate for your circumstances.  All investments involve risk, including loss of principal.  Quantopian makes no guarantees as to the accuracy or completeness of the views expressed in the website. The views are subject to change, and may have become unreliable for various reasons, including changes in market conditions or economic circumstances.
</p>

</div>
</div>
</div>

</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script></body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', "UA-8519877-1", {
    cookieDomain: "quantopian.com"
  });
  ga('set', 'dimension1', 'session_5f9dc7425d387f00077e48e4');
  
  ga('send', 'pageview');
</script>

<input type="hidden" name="is_mac" id="is_mac" value="false" />
<input type="hidden" name="mp" id="mp" value="75873953cd404bcc1da88a55ff51e3b4" />
<script>
  (function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("75873953cd404bcc1da88a55ff51e3b4");
</script>
<script>
  mixpanel.track("view page", {"page": window.location.pathname});
</script>
</html>
