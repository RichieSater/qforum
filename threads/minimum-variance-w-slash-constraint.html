<!DOCTYPE html>
<html>
<head>
<link href='i1.wp.com' rel='dns-prefetch'>
<link href='i2.wp.com' rel='dns-prefetch'>
<link href='i3.wp.com' rel='dns-prefetch'>
<meta content='2HgX9mcLHaPOX6sfaaAkhWtblhEB9yUNw4l6l46e1k4' name='google-site-verification'>
<link rel="shortcut icon" type="image/x-icon" href="external/favicon-q-ac1a76f2c200e9026b5b1147519bb4fab6256910588b831e2411bc6c7c1218c3.png" />
<title>
minimum variance w/ constraint
</title>
<meta content='For your consideration.  I got the list of securities from one of the postings on  https://www.quantopian.com/posts/for-robinhood-trading  .' name='description'>
<link rel="stylesheet" media="all" href="external/quanto-base-bundle-e8eb6050172aa0d24124d5c24bac90b2cccd88b5b9c7742026c0e9efab038c6e.css" />
<link rel="stylesheet" media="all" href="external/quanto-posts-bundle-aab01368d3f82d8dafc94ee9eabb82e77dc8c9fbbffa952fdcdc744dfa523cf3.css" />
<script src="external/quanto_global-057218867db29d5768131af5d6fb3476cef098e7d9e655108befb903c7ee985e.js"></script>
<script src="external/posts_bundle-3dfd82fa469c393d752e461d837aec9e4e364ae39f49198e34a6626f2180fdf7.js"></script>
<link href='external/logo-q-180x180-0f5a6a439c99203ed4aea6f656e7604c543d287be43d8b17c7591c1131f09a59.png' rel='apple-touch-icon'>
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="DcIfMs2Y/p20Xe2S+etbHTRHsGr7etjes7nZt5aI4mNxpGl/b24sfg1AtKO2BPNpDMmTA4G2zcUxtgLdPM2A2A==" />
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<script>
//<![CDATA[
window.quanto_data={};quanto_data.bounce_back_params={"show_modal":null,"feedback_text":null};quanto_data.namespace="public";quanto_data.talib_info={"ADOSC":["Chaikin A/D Oscillator (Volume Indicators)",["fastperiod","3"],["slowperiod","10"]],"ADX":["Average Directional Movement Index (Momentum Indicators)",["timeperiod","14"]],"ADXR":["Average Directional Movement Index Rating (Momentum Indicators)",["timeperiod","14"]],"APO":["Absolute Price Oscillator (Momentum Indicators)",["fastperiod","12"],["slowperiod","26"],["matype","0"]],"AROON":["Aroon (Momentum Indicators)",["timeperiod","14"]],"AROONOSC":["Aroon Oscillator (Momentum Indicators)",["timeperiod","14"]],"ATR":["Average True Range (Volatility Indicators)",["timeperiod","14"]],"BBANDS":["Bollinger Bands (Overlap Studies)",["timeperiod","5"],["nbdevup","2"],["nbdevdn","2"],["matype","0"]],"BETA":["Beta (Statistic Functions)",["timeperiod","5"]],"CCI":["Commodity Channel Index (Momentum Indicators)",["timeperiod","14"]],"CMO":["Chande Momentum Oscillator (Momentum Indicators)",["timeperiod","14"]],"CORREL":["Pearson's Correlation Coefficient (r) (Statistic Functions)",["timeperiod","30"]],"DEMA":["Double Exponential Moving Average (Overlap Studies)",["timeperiod","30"]],"DX":["Average Directional Movement Index (Momentum Indicators)",["timeperiod","14"]],"EMA":["Exponential Moving Average (Overlap Studies)",["timeperiod","30"]],"KAMA":["Kaufman Adaptive Moving Average (Overlap Studies)",["timeperiod","30"]],"LINEARREG":["Linear Regression (Statistic Functions)",["timeperiod","14"]],"LINEARREG_ANGLE":["Linear Regression Angle (Statistic Functions)",["timeperiod","14"]],"LINEARREG_INTERCEPT":["Linear Regression Intercept (Statistic Functions)",["timeperiod","14"]],"LINEARREG_SLOPE":["Linear Regression Slope (Statistic Functions)",["timeperiod","14"]],"MA":["Moving average (Overlap Studies)",["timeperiod","30"],["matype","0"]],"MACD":["Moving Average Convergence/Divergence (Momentum Indicators)",["fastperiod","12"],["slowperiod","26"],["signalperiod","9"]],"MACDEXT":["MACD with controllable MA type (Momentum Indicators)",["fastperiod","12"],["fastmatype","0"],["slowperiod","26"],["slowmatype","0"],["signalperiod","9"],["signalmatype","0"]],"MACDFIX":["Moving Average Convergence/Divergence Fix 12/26 (Momentum Indicators)",["signalperiod","9"]],"MAX":["Highest values over a specified period (Math Operators)",["timeperiod","30"]],"MAXINDEX":["Index of highest value over a specified period (Math Operators)",["timeperiod","30"]],"MFI":["Money Flow Index (Momentum Indicators)",["timeperiod","14"]],"MIDPOINT":["Midpoint over period (Overlap Studies)",["timeperiod","14"]],"MIDPRICE":["Midpoint Price over period (Overlap Studies)",["timeperiod","14"]],"MIN":["Lowest value over a specified period (Math Operators)",["timeperiod","30"]],"MININDEX":["Index of lowest value over a specified period (Math Operators)",["timeperiod","30"]],"MINMAX":["Lowest and highest values over a specified period (Math Operators)",["timeperiod","30"]],"MINMAXINDEX":["Indexes of lowest and highest values over a specified period (Math Operators)",["timeperiod","30"]],"MINUS_DI":["Minus Directional Indicator (Momentum Indicators)",["timeperiod","14"]],"MINUS_DM":["Minus Directional Movement (Momentum Indicators)",["timeperiod","14"]],"MOM":["Momentum (Momentum Indicators)",["timeperiod","10"]],"NATR":["Normalized Average True Range (Volatility Indicators)",["timeperiod","14"]],"PLUS_DI":["Plus Directional Indicator (Momentum Indicators)",["timeperiod","14"]],"PLUS_DM":["Plus Directional Movement (Momentum Indicators)",["timeperiod","14"]],"PPO":["Percentage Price Oscillator (Momentum Indicators)",["fastperiod","12"],["slowperiod","26"],["matype","0"]],"ROC":["Rate of change: ((price/prevPrice)-1)*100 (Momentum Indicators)",["timeperiod","10"]],"ROCP":["Rate of change Percentage: (price-prevPrice)/prevPrice (Momentum Indicators)",["timeperiod","10"]],"ROCR":["Rate of change ratio: (price/prevPrice) (Momentum Indicators)",["timeperiod","10"]],"ROCR100":["Rate of change ratio 100 scale: (price/prevPrice)*100 (Momentum Indicators)",["timeperiod","10"]],"RSI":["Relative Strength Index (Momentum Indicators)",["timeperiod","14"]],"SMA":["Simple Moving Average (Overlap Studies)",["timeperiod","30"]],"STDDEV":["Standard Deviation (Statistic Functions)",["timeperiod","5"],["nbdev","1"]],"STOCH":["Stochastic (Momentum Indicators)",["fastk_period","5"],["slowk_period","3"],["slowk_matype","0"],["slowd_period","3"],["slowd_matype","0"]],"STOCHF":["Stochastic Fast (Momentum Indicators)",["fastk_period","5"],["fastd_period","3"],["fastd_matype","0"]],"STOCHRSI":["Stochastic Relative Strength Index (Momentum Indicators)",["timeperiod","14"],["fastk_period","5"],["fastd_period","3"],["fastd_matype","0"]],"T3":["Triple Exponential Moving Average (T3) (Overlap Studies)",["timeperiod","5"],["vfactor","0.7"]],"TEMA":["Triple Exponential Moving Average (Overlap Studies)",["timeperiod","30"]],"TRIMA":["Triangular Moving Average (Overlap Studies)",["timeperiod","30"]],"TRIX":["1-day Rate-Of-Change (ROC) of a Triple Smooth EMA (Momentum Indicators)",["timeperiod","30"]],"TSF":["Time Series Forecast (Statistic Functions)",["timeperiod","14"]],"ULTOSC":["Ultimate Oscillator (Momentum Indicators)",["timeperiod1","7"],["timeperiod2","14"],["timeperiod3","28"]],"VAR":["Variance (Statistic Functions)",["timeperiod","5"],["nbdev","1"]],"WILLR":["Williams' %R (Momentum Indicators)",["timeperiod","14"]],"WMA":["Weighted Moving Average (Overlap Studies)",["timeperiod","30"]]};quanto_data.nb_preview_url="https://notebooks-preview.prd.pub.quantopian.com";quanto_data.delay_nb_preview_load=false;
//]]>
</script>
<meta content='https://www.quantopian.com/posts/minimum-variance-w-slash-constraint' property='og:url'>
<meta content='minimum variance w/ constraint' property='og:title'>

<input type="hidden" name="env" id="quanto-env" value="production" />
<meta content='550580758292093' property='fb:app_id'>
<meta content='https://www.quantopian.com/posts/minimum-variance-w-slash-constraint' property='og:url'>
<meta content='https://media.quantopian.com/public/og-image-default.png' property='og:image'>
<meta content='minimum variance w/ constraint' property='og:title'>
<meta content='For your consideration.  I got the list of securities from one of the postings on  https://www.quantopian.com/posts/for-robinhood-trading  .' property='og:description'>
</head>
<script type='application/ld+json'>
  {
    "@context": "http://schema.org",
    "@type": "Organization",
    "url": "https://www.quantopian.com",
    "logo": "https://media.quantopian.com/logos/logo-q-press-red.png"
  }
</script>
<body class='' ontouchstart=''>
<div id='fb-root'></div>
<div class='wrapper'>
<div class='alert-v2 error'>
<div class='message'>
Quantopian's community platform is shutting down. Please read <a href="/posts/quantopians-community-services-are-closing">this post</a> for more information and <a href='/account#account'>download your code</a>.
</div>
</div>
<div class='navbar navbar-default navbar-static-top' id='app-navbar'>
<div class='container-fluid'>
<div class='navbar-header'>
<button class='navbar-toggle collapsed' data-target='#app-navbar-collapse' data-toggle='collapse'>
<span class='icon hamburger-menu'></span>
</button>
<a class='navbar-brand' href='/home'>
<img class='logo-image async-image' data-src='external/logo-q-white-b141ea6018546e5a4ecc3d10d8440ec076fc4385764e948b322828cc70950a76.svg'>
</a>
</div>
<div class='collapse navbar-collapse' id='app-navbar-collapse'>
<ul class='nav navbar-nav navbar-right'>
<li class='dropdown quanto-dropdown-new'>
<li>
<a class='header' href='/docs'>
Documentation
</a>
</li>
<li class='dropdown quanto-dropdown-new'>
<a class='header' data-toggle='dropdown' href='#'>
Learn
</a>
<ul class='dropdown-menu'>
<li>
<a class='mixpanel-button' data-event='main nav getting started clicked' href='/tutorials/getting-started'>Getting Started</a>
</li>
<li>
<a class='mixpanel-button' data-event='main nav tutorials clicked' href='/tutorials'>Tutorials</a>
</li>
<li>
<a class='mixpanel-button' data-event='main nav lectures clicked' href='/lectures'>Lectures</a>
</li>
</ul>
</li>
<li>
<a class='header' href='/posts' id='forum-link'>
Forum
</a>
</li>
<li>
<a class="header" href="/signin?return_to=/posts/minimum-variance-w-slash-constraint">Log In</a>
</li>
</li>

</ul>
</div>
</div>
</div>
<script>
  $(document).ready(function () {
    quanto.instances.fm = new quanto.FeedbackManager();
    quanto.instances.hm = new quanto.headerManager();
  })
</script>


<div class='content content-area new-style'>
<input type="hidden" name="page-id" id="page-id" value="postatomic" />
<script src="external/MathJax.js?config=TeX-AMS_HTML-full.js,Safe" async="async"></script>
<div class='container page-container post-atomic'>
<input id='parent-post-id-val' type='hidden' value='56b6021b3f3b36b519000924'>
<div class='post-container' data-post-id='56b6021b3f3b36b519000924' id='56b6021b3f3b36b519000924'>
<div class='back-button back-to-community'>Back to Community</div>
<div class='post-title'>minimum variance w/ constraint</div>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<span class='posted-at'>posted </span>
<span UTCms='1454768667000' class='quanto-date posted-at'></span>
<div class='pull-right other-actions'>
<div class='dropup inline-block'>
<div class='dropdown share-control other-action-link'>
<div data-toggle='dropdown'>
<div class='share-image'></div>
Share
</div>
<ul class='dropdown-menu share-options-menu'>
<li>
<a class='share-row' href='https://twitter.com/intent/tweet?text=minimum variance w/ constraint&amp;url=https%3A%2F%2Fwww.quantopian.com%2Fposts%2Fminimum-variance-w-slash-constraint%3Futm_source%3Dwebsite_share%26utm_campaign%3Dminimum-variance-w-slash-constraint%26utm_medium%3Dtwitter&amp;via=quantopian'>
<i class='icon icon-twitter'></i>
Share on Twitter
</a>
</li>
<li>
<div class='share-row facebook-button'>
<i class='icon icon-facebook'></i>
Share on Facebook
</div>
</li>
<li>
<div class='share-row linkedin-button' data-share-url='https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fwww.quantopian.com%2Fposts%2Fminimum-variance-w-slash-constraint%3Futm_source%3Dwebsite_share%26utm_campaign%3Dminimum-variance-w-slash-constraint%26utm_medium%3Dlinkedin&amp;title=minimum+variance+w%2F+constraint+%28Grant+Kiehne%29&amp;source=Quantopian'>
<i class='icon icon-linkedin'></i>
Share on LinkedIn
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>

<div class='tags tag-row'>
<a class='tag mixpanel-button' data-event='tag click' data-mixpanel='Portfolio Optimization' data-tag-id='55d33f293f6ba10061000000' href='/posts/tag/Portfolio-Optimization/newest'>Portfolio Optimization</a>
<a class='tag mixpanel-button' data-event='tag click' data-mixpanel='Asset Allocation' data-tag-id='55d33f4f3f6ba10061000001' href='/posts/tag/Asset-Allocation/newest'>Asset Allocation</a>
<a class='tag mixpanel-button' data-event='tag click' data-mixpanel='ETFs' data-tag-id='55d33f633f6ba10065000001' href='/posts/tag/ETFs/newest'>ETFs</a>
</div>
<input type="hidden" name="social_fb_post_link" id="social_fb_post_link" value="https://www.quantopian.com/posts/minimum-variance-w-slash-constraint?utm_source=website_share&amp;utm_campaign=minimum-variance-w-slash-constraint&amp;utm_medium=facebook" />
<input type="hidden" name="social_post_image" id="social_post_image" value="external/logo-q-red-outline.png" />
<input type="hidden" name="social_post_author" id="social_post_author" value="Grant Kiehne" />
<div class='body-text'>
<div class='body-text-container post-body'><p>For your consideration.  I got the list of securities from one of the postings on <a href="https://www.quantopian.com/posts/for-robinhood-trading">https://www.quantopian.com/posts/for-robinhood-trading</a> .  </p>
</div>
</div>
</div>

</div>

<div class='container page-container post-atomic'>
<div class='section-header reply-header'>
<div class='reply-title'>69 responses</div>
</div>
<div class='replies'>
<div class='post-container response-container' data-post-id='56b62019a4a36a79da000059' id='56b62019a4a36a79da000059'>
<a href='#56b62019a4a36a79da000059'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1454776351000' class='quanto-date posted-at response-posted-at' href='#56b62019a4a36a79da000059'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Here&#39;s a tweak.  Instead of 
<code>context.eps = 0.01</code> I set <code>context.eps = 0.05</code>.  Seems decent.  Comment/criticisms/improvements welcome.  --Grant  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b68776acbe9272eb000130' id='56b68776acbe9272eb000130'>
<a href='#56b68776acbe9272eb000130'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1454802813000' class='quanto-date posted-at response-posted-at' href='#56b68776acbe9272eb000130'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Here&#39;s another tweak.  I changed 
<code>if denom &gt; 0 and np.dot(allocation,ret_norm) &gt;= 0:</code> to <code>if denom &gt; 0:</code> .  The former was probably resulting in the optimization not being applied, when it should have been.  </p>

<p>[EDIT] I also changed to this:</p>

<pre><code>    x1 = 1.0*np.ones_like(context.stocks)/len(context.stocks)  
    res= scipy.optimize.minimize(variance, context.x1, args=ret,jac=jac_variance, method=&#39;SLSQP&#39;,constraints=cons,bounds=bnds)  
</code></pre>

<p>The seed for the optimization is an equal weight portfolio.</p>

<p>--Grant  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b690041efdb3e3e8000116' id='56b690041efdb3e3e8000116'>
<a href='#56b690041efdb3e3e8000116'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/51112f848ecce77ec7000153'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/1accfb691779fc8875f7e2a3ef5c6b7c?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/51112f848ecce77ec7000153'>Andrew Czeizler</a>
</div>
<a UTCms='1454805000000' class='quanto-date posted-at response-posted-at' href='#56b690041efdb3e3e8000116'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Awesome algorithm Grant.<br>
Could you please give a brief explanation regarding the constraints of the optimization.<br>
Many thanks,<br>
Andrew  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b6aebf33f3c6e3450004c2' id='56b6aebf33f3c6e3450004c2'>
<a href='#56b6aebf33f3c6e3450004c2'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/55ed0ebaf7eced2820000138'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/192fde5a5de866362a9e34c096cb8a9b?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/55ed0ebaf7eced2820000138'>Minh</a>
</div>
<a UTCms='1454812867000' class='quanto-date posted-at response-posted-at' href='#56b6aebf33f3c6e3450004c2'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Incredible returns. Now I&#39;m tempted to try it after that original post for Robinhood.</p>

<p>Edit:</p>

<p>Grant, Can you explain what is the purpose of this line for the constraint?</p>

<pre><code>&#39;type&#39;: &#39;ineq&#39;, &#39;fun&#39;: lambda x:  np.dot(x,ret_norm)-context.eps}
</code></pre>

<p>I&#39;m not sure I understand what is ret_norm or eps.</p>

<p>EDIT 2:</p>

<p>Nevermind I figured it out. You are seeking a return or greater based on the normal distribution.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b6c762a4a36af4fe0001e4' id='56b6c762a4a36af4fe0001e4'>
<a href='#56b6c762a4a36af4fe0001e4'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1454819174000' class='quanto-date posted-at response-posted-at' href='#56b6c762a4a36af4fe0001e4'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Andrew,</p>

<p>This code computes the mean return normalized by the standard deviation:</p>

<pre><code>    ret_mean = prices.pct_change().mean()  
    ret_std = prices.pct_change().std()  
    ret_norm = ret_mean/ret_std  
    ret_norm = ret_norm.as_matrix(context.stocks)  
</code></pre>

<p>Then, the normalized mean return is included as a constraint:</p>

<pre><code>    cons = ({&#39;type&#39;: &#39;eq&#39;, &#39;fun&#39;: lambda x:  np.sum(x)-1.0},  
    {&#39;type&#39;: &#39;ineq&#39;, &#39;fun&#39;: lambda x:  np.dot(x,ret_norm)-context.eps})  
</code></pre>

<p>The variable <code>x</code> is the portfolio asset allocation/weight vector.  The first constraint is a leverage constraint--the weights need to sum to one.  The second constraint is saying that the sum of the normalized returns weighted by the portfolio allocations needs to be equal to or greater than a threshold, <code>context.eps</code>.  It should tilt the portfolio toward assets with positive risk-adjusted returns.</p>

<p>By the way, I suspect that there may be a closed-form, analytic solution to the constrained optimization problem solved here iteratively.  An attaboy to the first person to post it.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b6cae31efdb3facb00039e' id='56b6cae31efdb3facb00039e'>
<a href='#56b6cae31efdb3facb00039e'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/51112f848ecce77ec7000153'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/1accfb691779fc8875f7e2a3ef5c6b7c?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/51112f848ecce77ec7000153'>Andrew Czeizler</a>
</div>
<a UTCms='1454820072000' class='quanto-date posted-at response-posted-at' href='#56b6cae31efdb3facb00039e'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks grant!<br>
Awesome returns!  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b76cc4a8e886a12300002a' id='56b76cc4a8e886a12300002a'>
<a href='#56b76cc4a8e886a12300002a'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/52b0e0e0271a27fc88000049'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/e5451406e743420c700eb2b054b2fc57?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/52b0e0e0271a27fc88000049'>Blue Seahawk</a>
</div>
<a UTCms='1454861513000' class='quanto-date posted-at response-posted-at' href='#56b76cc4a8e886a12300002a'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Most recent algo <a href="https://www.quantopian.com/posts/pvr">PvR</a> out, accounting for the negative cash, <strong>108.6%</strong>, or 0.0833 %/day:</p>

<pre><code>2016-02-04_pvr_:132INFO PvR 0.0833 %/day     2010-12-01 to 2016-02-04  10000  minute  
2016-02-04_pvr_:135INFO  Profited 35134 on 32362 activated/transacted for PvR of 108.6%  
2016-02-04_pvr_:138INFO  QRet 351.34 PvR 108.57 CshLw -22362 MxLv 1.50 RskHi 32362 Shrts 0  
</code></pre>

<p>This algo ranks 6th in PvR/day among 61 tested this week, very good.<br>
Just that it would be useful to see a version of it without margin, and <a href="https://www.quantopian.com/posts/for-robinhood-trading#56b67779be1c246d920000a9">as happened</a> could maybe bring overall higher profitability.</p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b76f36983618c863000046' id='56b76f36983618c863000046'>
<a href='#56b76f36983618c863000046'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1454862145000' class='quanto-date posted-at response-posted-at' href='#56b76f36983618c863000046'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>How do you suggest eliminating margin, other than holding a small positive cash balance (which will just be dead capital and cut into the return)?  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b773878b14b70a0a000076' id='56b773878b14b70a0a000076'>
<a href='#56b773878b14b70a0a000076'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/52b0e0e0271a27fc88000049'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/e5451406e743420c700eb2b054b2fc57?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/52b0e0e0271a27fc88000049'>Blue Seahawk</a>
</div>
<a UTCms='1454863246000' class='quanto-date posted-at response-posted-at' href='#56b773878b14b70a0a000076'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Maybe whatever magic it was that Tim V. did with his Robinhood algo to eliminate negative cash, I haven&#39;t tried to understand it yet.</p>

<p>Ideally speaking, beyond that, an ordering wrapper for all of the order methods that would monitor fills (including partial fills and unfilled) and adjust weights accordingly, not easy. Orders would be first queued in any frame, then analyzed wrt current cash, adjusted, ordered.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b778b08b14b76f02000092' id='56b778b08b14b76f02000092'>
<a href='#56b778b08b14b76f02000092'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1454864567000' class='quanto-date posted-at response-posted-at' href='#56b778b08b14b76f02000092'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks.  I see the problem now with this code:</p>

<pre><code>def handle_data(context,data):  
    context.leverage.append(context.account.leverage)  
    record(max_leverage = max(context.leverage))  
</code></pre>

<p>It is a mystery how the leverage could spike during the day, but settle to 1 by the close.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b7b1fca8e886a12300025f' id='56b7b1fca8e886a12300025f'>
<a href='#56b7b1fca8e886a12300025f'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1454879232000' class='quanto-date posted-at response-posted-at' href='#56b7b1fca8e886a12300025f'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Here&#39;s a backtest indicating that the leverage pops up above 1 significantly.  However, as shown above, at then end of the trading day, it is always near 1.  Any idea what&#39;s going on?  Maybe something fishy with the way 
<code>order_target_percent</code> is playing out?  I guess if all the orders aren&#39;t processed in one minute, leverage can be out of whack temporarily?  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b7d6c68b14b71a9a000145' id='56b7d6c68b14b71a9a000145'>
<a href='#56b7d6c68b14b71a9a000145'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/52b0e0e0271a27fc88000049'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/e5451406e743420c700eb2b054b2fc57?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/52b0e0e0271a27fc88000049'>Blue Seahawk</a>
</div>
<a UTCms='1454888652000' class='quanto-date posted-at response-posted-at' href='#56b7d6c68b14b71a9a000145'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>You can add your own context variables in <a href="https://www.quantopian.com/posts/track-orders">track_orders()</a> here to experiment toward solutions etc.<br>
The number at the beginning of lines -- minute of the day.<br>
Would like to point out that you&#39;ll (rarely) see partial fills and they have the slash like<br>
  Bot 50/63 EDV at 80.50 or Sold -250/-285 XIV at 15.32<br>
So if you scroll and copy the output you can search for &#39;/&#39; and find those.<br>
Can also search for &#39;cash -&#39; to find negative cash.<br>
The order id logging option is turned on.<br>
There is a line like this each time there&#39;s a new leverage high:<br>
  2010-12-14pvr:346INFO 99 MaxLv 1.01 QRet -0.7 PvR -0.7 RskHi 10068</p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b86a38a8e886b255000376' id='56b86a38a8e886b255000376'>
<a href='#56b86a38a8e886b255000376'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/52b0e0e0271a27fc88000049'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/e5451406e743420c700eb2b054b2fc57?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/52b0e0e0271a27fc88000049'>Blue Seahawk</a>
</div>
<a UTCms='1454926397000' class='quanto-date posted-at response-posted-at' href='#56b86a38a8e886b255000376'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>I took a closer look, sell orders are going unfilled for numerous minutes sometimes while buys do go through right away and that accounts for the leverage spikes and deep negative cash.<br>
So here&#39;s one suggestion:<br>
a) In place of order_target_percent(), queue the orders.<br>
b) In handle_data, every minute, if there are any queued orders ( if context.queue_list: ), call a function that will process those orders only if/when there are no open orders. Wish/hope there were/is a better way.<br>
c) Set to process any sells first and then wait for them to be filled before buy. Or better, could only place buys when there is likely enough breathing room in available cash for slippage and commissions (so as long as one or more sells are done, allow any buys that can fit).</p>

<p>To determine whether a transaction ratio (&quot;percentage&quot; being fed to order_target_percent()) is a sell or buy (both are positive and simply adjustments, a lower number than existing is a sell), have to take a look at its current percentage of the portfolio compared to the new weight, allocation[i] that is stored/queued.</p>

<p>I wrote the bit above and then decided to work on it so I&#39;ll probably have a backtest approaching that fairly soon.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b87748a8e8863ef70003b1' id='56b87748a8e8863ef70003b1'>
<a href='#56b87748a8e8863ef70003b1'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1454929741000' class='quanto-date posted-at response-posted-at' href='#56b87748a8e8863ef70003b1'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks.  I figured something like you describe could be happening.  By the way, I posted a question to <a href="https://www.quantopian.com/posts/zero-commission-algorithmic-trading-robinhood-and-quantopian">https://www.quantopian.com/posts/zero-commission-algorithmic-trading-robinhood-and-quantopian</a>.  It seems that 
<code>order_target_percent()</code> is not gonna work for re-balancing under Robinhood, unless enough cash is sitting around to cover the T+3 rule.  If I understand correctly, it&#39;ll need to be something like  <code>order_target_percent_sell()</code> followed by <code>order_target_percent_buy()</code> three days later when the cash from the sale is available.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b9683cc3c398a1c200053e' id='56b9683cc3c398a1c200053e'>
<a href='#56b9683cc3c398a1c200053e'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/52b0e0e0271a27fc88000049'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/e5451406e743420c700eb2b054b2fc57?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/52b0e0e0271a27fc88000049'>Blue Seahawk</a>
</div>
<a UTCms='1454991423000' class='quanto-date posted-at response-posted-at' href='#56b9683cc3c398a1c200053e'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Hi Grant,</p>

<p>Reviewing: Thanks to the <a href="https://www.quantopian.com/posts/pvr">PvR (Profit vs Risk)</a> code I added it became apparent that the third algo appearing to be over 300% was really 108% in profit per dollar spent because of -22k in negative cash. It did actually profit 35k, just that it took 32k to make that, not 10k.</p>

<p>This new version of the algorithm does not go into negative cash and the result is pretty interesting.<br>
It spends only 10k and ends with 44k so instead of 108% it is now a <strong>genuine 344.6% return per dollar spent</strong>, no margin.</p>

<p>The attached code adds a routine to queue orders, handle sells first, wait for them to be filled, then buy after that.<br>
It also contains a suggested start toward the Robinhood T+3 you mentioned.<br>
In the <a href="https://www.quantopian.com/posts/track-orders">track_orders function</a> output you&#39;ll see unfilled&#39;s. Its output can be toggled off. The first digit is minute of the day.</p>

<p>The genuine 344.6% return makes this the second best algo I&#39;ve seen so far in PvR per day, kudos Grant Kiehne.<br>
  (and me, if I do say so myself)</p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b9b82ad9bc6d4b040007b3' id='56b9b82ad9bc6d4b040007b3'>
<a href='#56b9b82ad9bc6d4b040007b3'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/51112f848ecce77ec7000153'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/1accfb691779fc8875f7e2a3ef5c6b7c?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/51112f848ecce77ec7000153'>Andrew Czeizler</a>
</div>
<a UTCms='1455011886000' class='quanto-date posted-at response-posted-at' href='#56b9b82ad9bc6d4b040007b3'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Fantastic algorithm guys!!<br>
during july 2015 to jan 2016 it seems the algorithm plateaus and declines.<br>
I was wondering if more diagnostics can be run for this period to see if it is one instrument causing this decline or the group generally moving in a downward trend. essentially trying to use these diagnostics to maybe add more constraints and hence improve the algorithm.<br>
Many thanks all,<br>
Best,<br>
Andrew  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56b9b93d5552f5c7780006eb' id='56b9b93d5552f5c7780006eb'>
<a href='#56b9b93d5552f5c7780006eb'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1455012167000' class='quanto-date posted-at response-posted-at' href='#56b9b93d5552f5c7780006eb'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks garyha,  Glad you found it interesting.  So if this is &quot;the second best algo&quot; what&#39;s the first?  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56ba460cc2ec3a78e0000175' id='56ba460cc2ec3a78e0000175'>
<a href='#56ba460cc2ec3a78e0000175'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/52b0e0e0271a27fc88000049'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/e5451406e743420c700eb2b054b2fc57?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/52b0e0e0271a27fc88000049'>Blue Seahawk</a>
</div>
<a UTCms='1455048212000' class='quanto-date posted-at response-posted-at' href='#56ba460cc2ec3a78e0000175'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>@AC, try setting a track_orders start date in that like the example in code.<br>
@GK, Only revealed to those onboard with <a href="https://www.quantopian.com/posts/pvr">PvR</a>, not the majority who look the other way.</p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56bb44508dce2c537a0004c2' id='56bb44508dce2c537a0004c2'>
<a href='#56bb44508dce2c537a0004c2'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/5590c016248f1472ae000286'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/1a2b21eaf54a819d57cb3044dba06888?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/5590c016248f1472ae000286'>Tim Vidmar</a>
</div>
<a UTCms='1455113301000' class='quanto-date posted-at response-posted-at' href='#56bb44508dce2c537a0004c2'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Added an emulation of Robinhood&#39;s 3-day delay in the availability of the proceedings, following an example in the Q API help.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56bb44936a4227f17f0009dc' id='56bb44936a4227f17f0009dc'>
<a href='#56bb44936a4227f17f0009dc'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/5590c016248f1472ae000286'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/1a2b21eaf54a819d57cb3044dba06888?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/5590c016248f1472ae000286'>Tim Vidmar</a>
</div>
<a UTCms='1455113368000' class='quanto-date posted-at response-posted-at' href='#56bb44936a4227f17f0009dc'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>A tear sheet for the algo from the previous post.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56bc6a92619461941d0009ca' id='56bc6a92619461941d0009ca'>
<a href='#56bc6a92619461941d0009ca'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/51112f848ecce77ec7000153'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/1accfb691779fc8875f7e2a3ef5c6b7c?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/51112f848ecce77ec7000153'>Andrew Czeizler</a>
</div>
<a UTCms='1455188633000' class='quanto-date posted-at response-posted-at' href='#56bc6a92619461941d0009ca'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>hi  garyha!<br>
Would you be able to provide some more information as to what algorithm performs a better<br>
PVR metric.<br>
Many thanks,<br>
Best,<br>
Andrew  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56bc6f83cc9d87333300083b' id='56bc6f83cc9d87333300083b'>
<a href='#56bc6f83cc9d87333300083b'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1455189901000' class='quanto-date posted-at response-posted-at' href='#56bc6f83cc9d87333300083b'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Interesting that it holds up to the T+3 restriction.</p>

<p>One thought I had is that for such a strategy, it might be better to adjust the weights on a rolling basis, every day/minute, under the T+3 rule, rather than scheduling a function to run periodically.  One would also have to consider the problem of not being able to buy fractional shares, as well.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56bc7bc7cc9d873333000905' id='56bc7bc7cc9d873333000905'>
<a href='#56bc7bc7cc9d873333000905'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/51d125a71144e60865000044'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/b7dd86784deedc047d5ad0fb30378bdd?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/51d125a71144e60865000044'>Peter Bakker</a>
</div>
<a UTCms='1455193038000' class='quanto-date posted-at response-posted-at' href='#56bc7bc7cc9d873333000905'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>small tweak to make the T+3 restriction dynamic based on the environment  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56bc9840dcfb7080a9000090' id='56bc9840dcfb7080a9000090'>
<a href='#56bc9840dcfb7080a9000090'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/5590c016248f1472ae000286'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/1a2b21eaf54a819d57cb3044dba06888?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/5590c016248f1472ae000286'>Tim Vidmar</a>
</div>
<a UTCms='1455200326000' class='quanto-date posted-at response-posted-at' href='#56bc9840dcfb7080a9000090'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>A tiny correction to the last post: the call of the <em>check_last_sale</em> subroutine should only be done in  backtesting, i.e., the corresponding piece of code in the <em>trade</em> subroutine should read</p>

<p><strong>if arena not in [&#39;IB&#39;, &#39;ROBINHOOD&#39;]:<br>
    # Backtesting<br>
    check_last_sale(context)</strong></p>

<p>instead of just</p>

<p><strong>check_last_sale(context)</strong>  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56bc9a1e2cf809dc2c000093' id='56bc9a1e2cf809dc2c000093'>
<a href='#56bc9a1e2cf809dc2c000093'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/5590c016248f1472ae000286'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/1a2b21eaf54a819d57cb3044dba06888?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/5590c016248f1472ae000286'>Tim Vidmar</a>
</div>
<a UTCms='1455200809000' class='quanto-date posted-at response-posted-at' href='#56bc9a1e2cf809dc2c000093'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Grant,</p>

<blockquote>
<blockquote>
<p>Interesting that it holds up to the T+3 restriction.</p>
</blockquote>
</blockquote>

<p>I hope I implemented the 3-day delay correctly ...  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56bdf4edd7607d3047000646' id='56bdf4edd7607d3047000646'>
<a href='#56bdf4edd7607d3047000646'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/51e55a023d55a39977000031'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/8530ea59812d00290f84a73420b86a22?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/51e55a023d55a39977000031'>Richard Prokopyshen</a>
</div>
<a UTCms='1455289588000' class='quanto-date posted-at response-posted-at' href='#56bdf4edd7607d3047000646'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>I added some log.info&#39;s to the allocate routine  see if the optimizer ever had trouble finding a solution like this:  </p>

<pre><code>if res.success:  
        log.info(&quot;AOK scipy.optimize res.success=False&quot;)  
        allocation = res.x  
        allocation[allocation&lt;0] = 0  
        denom = np.sum(allocation)  
        if denom &gt; 0:  
            allocation = allocation/denom  
else:  
        log.info(&quot;WRN scipy.optimize res.success=False&quot;)  
        allocation = np.copy(context.x0)  
</code></pre>

<p>Running a backtest for 11-January-2016 to 15-Jan-2016 there seems to be some days where the optimizer is unable to get a solution and moved to an equal weight default.  From run log, looks to me like optimizer found a solution on 2 out of 5 days:</p>

<pre><code>2016-01-11pvr:359INFO2016-01-11 to 2016-01-15  10000  minute  
2016-01-11allocate:178INFOWRN scipy.optimize res.success=False  
2016-01-12allocate:178INFOWRN scipy.optimize res.success=False  
2016-01-12trade:112INFO    61 EDV 0.000 ==&gt; 0.250  
2016-01-12trade:112INFO    61 TLT 0.000 ==&gt; 0.250  
2016-01-12trade:112INFO    61 RSP 0.000 ==&gt; 0.250  
2016-01-12trade:112INFO    61 XIV 0.000 ==&gt; 0.250  
2016-01-12_orders:241INFO  61   Buy 34 RSP at 72.04   cash 10000 d96f007e8b4e456a85483d74d25354af  
2016-01-12_orders:241INFO  61   Buy 20 TLT at 122.81   cash 10000 ad6906801e6a4d09a4ef7a130d22b9ea  
2016-01-12_orders:241INFO  61   Buy 114 XIV at 21.53   cash 10000 d6d2460edd8a470796051c646c5a7188  
2016-01-12_orders:241INFO  61   Buy 21 EDV at 116.57   cash 10000 b566d65685f54fa28e086e1ee23e409e  
2016-01-12_orders:241INFO  62      Bot 34 RSP at 72.04   cash 2645 d96f007e8b4e456a85483d74d25354af  
2016-01-12_orders:241INFO  62         EDV 21 unfilled  b566d65685f54fa28e086e1ee23e409e  
2016-01-12_orders:241INFO  62      Bot 114 XIV at 21.48   cash 2645 d6d2460edd8a470796051c646c5a7188  
2016-01-12_orders:241INFO  62      Bot 20 TLT at 122.82   cash 2645 ad6906801e6a4d09a4ef7a130d22b9ea  
2016-01-12_orders:241INFO  63      Bot 21 EDV at 116.48   cash 196 b566d65685f54fa28e086e1ee23e409e  
2016-01-12pvr:453INFO 63 MaxLv 0.98 QRet 0.1 PvR 0.1 RskHi 9803  
2016-01-13allocate:171INFOAOK scipy.optimize res.success=True  
2016-01-14allocate:178INFOWRN scipy.optimize res.success=False  
2016-01-15allocate:171INFOAOK scipy.optimize res.success=True  
2016-01-15_pvr_:429INFOPvR -0.5568 %/day     2016-01-11 to 2016-01-15  10000  minute  
2016-01-15_pvr_:432INFO  Profited -273 on 9803 activated/transacted for PvR of -2.8%  
2016-01-15_pvr_:435INFO  QRet -2.73 PvR -2.78 CshLw 196 MxLv 0.98 RskHi 9803 Shrts 0  
End of logs.  
</code></pre>

<p>Comments or perspective or is this normal-operation or ?  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56bf0889c6049cfd6a000528' id='56bf0889c6049cfd6a000528'>
<a href='#56bf0889c6049cfd6a000528'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1455360147000' class='quanto-date posted-at response-posted-at' href='#56bf0889c6049cfd6a000528'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks Richard,</p>

<p>I&#39;m not sure what&#39;s going on with the optimizer.  Note that there is an option to display what&#39;s going on under the hood (see <a href="http://docs.scipy.org/doc/scipy/reference/optimize.minimize-slsqp.html">http://docs.scipy.org/doc/scipy/reference/optimize.minimize-slsqp.html</a> and the &#39;disp&#39; flag).</p>

<p>As I noted above, there may be a closed-form solution (at least for an equality constraint, which may be sufficient).  I think this applies:</p>

<p><a href="http://quant.stackexchange.com/questions/18160/beta-constrained-markowitz-minimum-variance-portfolio-closed-form-solution">http://quant.stackexchange.com/questions/18160/beta-constrained-markowitz-minimum-variance-portfolio-closed-form-solution</a></p>

<p>Another approach would be to use CVXOPT instead of scipy.optimize to see if it always converges.</p>

<p>Grant  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56c0fa1222e0f66dfb00018a' id='56c0fa1222e0f66dfb00018a'>
<a href='#56c0fa1222e0f66dfb00018a'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/51112f848ecce77ec7000153'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/1accfb691779fc8875f7e2a3ef5c6b7c?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/51112f848ecce77ec7000153'>Andrew Czeizler</a>
</div>
<a UTCms='1455487510000' class='quanto-date posted-at response-posted-at' href='#56c0fa1222e0f66dfb00018a'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Hi all,<br>
I was wondering given the algorithm. how would it be possible to do performance attribution on the different instruments.<br>
Many thanks<br>
Andrew  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56c10055733e03ef9500001b' id='56c10055733e03ef9500001b'>
<a href='#56c10055733e03ef9500001b'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1455489113000' class='quanto-date posted-at response-posted-at' href='#56c10055733e03ef9500001b'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Andrew,</p>

<p>This might be relevant:</p>

<p><a href="https://www.quantopian.com/posts/round-trip-trade-analysis">https://www.quantopian.com/posts/round-trip-trade-analysis</a></p>

<p>Grant  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56c577bd52023779a50001a7' id='56c577bd52023779a50001a7'>
<a href='#56c577bd52023779a50001a7'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/54b8a7b4f44758bf5c000aea'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/4122a0b664faeb01757f54652164d960?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/54b8a7b4f44758bf5c000aea'>pangyuteng</a>
</div>
<a UTCms='1455781827000' class='quanto-date posted-at response-posted-at' href='#56c577bd52023779a50001a7'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>@ Grant.  Thanks for sharing.  I thought  SPY, SH &amp; TLT was already a great combo for minimum-variance optimization (mvo), until you presented this combination (RSP,EDV,TLT,XIV)!<br>
@All.  Any insights/tips on how this combination works so well with mvo? or any related articles on constructing a portfolio for mvo?</p>

<p>From a cursory look, the performance is attributed to the high return by XIV, and also the negative correlation of returns between RSP/XIV versus EDV/TLT (shown in first half of the notebook).  However, my hand picked stocks based on those 2 criteria did not do so well with mvo, as shown in the notebook.  If only we can reverse engineer why this combination do so well with mvo. :)  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56c57b0777313e743e0001e2' id='56c57b0777313e743e0001e2'>
<a href='#56c57b0777313e743e0001e2'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/54b8a7b4f44758bf5c000aea'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/4122a0b664faeb01757f54652164d960?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/54b8a7b4f44758bf5c000aea'>pangyuteng</a>
</div>
<a UTCms='1455782668000' class='quanto-date posted-at response-posted-at' href='#56c57b0777313e743e0001e2'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>I am also attaching my modification to the strategy, which attempts to reduce the volatility by limiting the XIV weight during rough times.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56c58ff277313e899d00025b' id='56c58ff277313e899d00025b'>
<a href='#56c58ff277313e899d00025b'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/525bc0ee7ace0dc6db000113'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/73ff156e6f6dad3b1b0e34c03bcf473a?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/525bc0ee7ace0dc6db000113'>Anthony FJ Garner</a>
</div>
<a UTCms='1455788024000' class='quanto-date posted-at response-posted-at' href='#56c58ff277313e899d00025b'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>My very strong advice would be to stop dikking around with 5 or 6 year back tests. Forget about looking at instruments with history so short they have been around for the blink of an eye.  And forget about Quantopian if it only provides you with such data. Zipline would be a far better option. You need to obtain or manufacture bond data going back over a very long a period of time. If you can&#39;t find it make your own using interest rate data from the Fed. There are no ETFs going back beyond 1996 so forget them too and either use stock indices or mutual fund data. You won&#39;t be able to lay your hands on minute data of course.</p>

<p>This is an excellent forum. There are many excellent drafters of code. But there don&#39;t seem to be many people who know what it means to live and trade through many different market cycles.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56c5a1ed52023779a50002e5' id='56c5a1ed52023779a50002e5'>
<a href='#56c5a1ed52023779a50002e5'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1455792631000' class='quanto-date posted-at response-posted-at' href='#56c5a1ed52023779a50002e5'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>@ Anthony, I&#39;m just a hack, while you might actually know what you are doing.  I&#39;m definitely not promoting this as a sensible investment.  I agree that the backtest time frame is too short for this algo.  It could be that the bull market gets amplified, and then as it flattens out toward the end, the algo just gets lucky.  It is limited by the availability of data for XIV.  So the limited time frame is a risk everyone should be aware of.  Maybe there is a way to cook up a proxy for XIV?  </p>

<p>@ Ted, looks like an improvement, but I&#39;d worry about over-fitting (particularly in light of Anthony&#39;s comments).  XIV is complete voodoo to me:</p>

<blockquote>
<p>The investment seeks to replicate, net of expenses, the inverse of the daily performance of the S&amp;P 500 VIX Short-Term Futures index. The index was designed to provide investors with exposure to one or more maturities of futures contracts on the VIX, which reflects implied volatility of the S&amp;P 500 Index at various points along the volatility forward curve. The calculation of the VIX is based on prices of put and call options on the S&amp;P 500 Index. The ETNs are linked to the daily inverse return of the index and do not represent an investment in the inverse of the VIX.</p>
</blockquote>

<p>Kinda scary that the strategy hinges on something that sounds pretty far removed from anything that a mere mortal could understand.</p>

<p>Regarding minimum variance optimization, keep in mind that the algo has a constraint that should tilt the portfolio toward securities that have higher volatility-normalized returns over the trailing window (at least that&#39;s what I had in mind).  I&#39;ve attached a backtest of your version, without the constraint, to illustrate the importance of the constraint.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56c5aadf77313e743e000319' id='56c5aadf77313e743e000319'>
<a href='#56c5aadf77313e743e000319'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/525bc0ee7ace0dc6db000113'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/73ff156e6f6dad3b1b0e34c03bcf473a?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/525bc0ee7ace0dc6db000113'>Anthony FJ Garner</a>
</div>
<a UTCms='1455794915000' class='quanto-date posted-at response-posted-at' href='#56c5aadf77313e743e000319'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Not N  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56c5ab449ea54dd19700004f' id='56c5ab449ea54dd19700004f'>
<a href='#56c5ab449ea54dd19700004f'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/525bc0ee7ace0dc6db000113'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/73ff156e6f6dad3b1b0e34c03bcf473a?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/525bc0ee7ace0dc6db000113'>Anthony FJ Garner</a>
</div>
<a UTCms='1455795019000' class='quanto-date posted-at response-posted-at' href='#56c5ab449ea54dd19700004f'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Not at all<br>
 I enjoy your work and admire your coding.  But I have traded more cock ups over the years than I care to recall!  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56c5e4813bde634986000032' id='56c5e4813bde634986000032'>
<a href='#56c5e4813bde634986000032'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/5101418fac8208878600070f'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/a0a0f85f92284a178a63fcf7a575a96e?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/5101418fac8208878600070f'>Mark  Brown</a>
</div>
<a UTCms='1455809671000' class='quanto-date posted-at response-posted-at' href='#56c5e4813bde634986000032'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>just trying to figure out what a &quot;cock ups&quot; is?  never traded that market myself. </p>

<p>also Anthony is correct to validate a system I use at least fifteen thousand bars up to one hundred twenty five thousand bars in testing.  i separate out the trending data and no-trending data, create synthetic random data and patch it all together in various configurations.  if your model holds up to this then you have no curve fit.  </p>

<p>also if your logic is sound you should be experiencing positive slippage on initial and when leveraging positions, otherwise i don&#39;t think a system will hold up to institutional trading size at least.   m  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56ce169798d2f34f9d000036' id='56ce169798d2f34f9d000036'>
<a href='#56ce169798d2f34f9d000036'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/56009dbb05de07c08d0001e4'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/8bb6068727562bb488da5bbdecf32474?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/56009dbb05de07c08d0001e4'>Evan LaRiviere</a>
</div>
<a UTCms='1456346782000' class='quanto-date posted-at response-posted-at' href='#56ce169798d2f34f9d000036'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Hey Grant --</p>

<p>I was wondering if you could help walk me through what this portion of the code is doing?:</p>

<pre><code>    bnds = []  
    limits = [0,1]  
    for stock in context.stocks:  
        bnds.append(limits)  
    bnds = tuple(tuple(x) for x in bnds)

    cons = ({&#39;type&#39;: &#39;eq&#39;, &#39;fun&#39;: lambda x:  np.sum(x)-1.0},  
            {&#39;type&#39;: &#39;ineq&#39;, &#39;fun&#39;: lambda x:  np.dot(x,ret_norm)-context.eps})  
    res= scipy.optimize.minimize(variance, context.x0, args=ret,jac=jac_variance, method=&#39;SLSQP&#39;,constraints=cons,bounds=bnds)  
    if res.success:  
        allocation = res.x  
        allocation[allocation&lt;0] = 0  
        denom = np.sum(allocation)  
        if denom &gt; 0 and np.dot(allocation,ret_norm) &gt;= 0:  
            allocation = allocation/denom  
    else:  
        allocation = np.copy(context.x0)  
    context.n += 1  
    context.s += allocation  
</code></pre>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56ce2ed5458dad1fe000000d' id='56ce2ed5458dad1fe000000d'>
<a href='#56ce2ed5458dad1fe000000d'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/56009dbb05de07c08d0001e4'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/8bb6068727562bb488da5bbdecf32474?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/56009dbb05de07c08d0001e4'>Evan LaRiviere</a>
</div>
<a UTCms='1456352984000' class='quanto-date posted-at response-posted-at' href='#56ce2ed5458dad1fe000000d'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>It looks like the main goal of the algo is to get to the scheduled function call trade:</p>

<pre><code>def trade(context, data):  
    print (&#39;Current context.n: &#39;,context.n)  
    if context.n &gt; 0:  
        allocation = context.s/context.n  
        print(&#39;Required Allocation: &#39;,allocation)  
    else:  
        return  
    context.n = 0  
    context.s = np.zeros_like(context.stocks)  
    context.x0 = allocation  
    if get_open_orders():  
        return  
    for i,stock in enumerate(context.stocks):  
        order_target_percent(stock,allocation[i])  
</code></pre>

<p>With order_target_percent(stock,allocation[i]) as the trading execution portion. I changed some of the stocks in context.stocks and reran the algo. I also printed out context.n and allocation whenever trade() was called. I got the log output below. Can you help me understand what context.n is? What&#39;s the relationship to allocation? even though it&#39;s context.s / context.n it doesn&#39;t seem to change even when n increases or decreases:</p>

<p>2015-12-01 -- PRINT(&#39;Required Allocation: &#39;, array([0.25, 0.25, 0.25, 0.25], dtype=object))<br>
2015-12-08 -- PRINT(&#39;Current context.n: &#39;, 5)<br>
2015-12-08 -- PRINT(&#39;Required Allocation: &#39;, array([0.25, 0.25, 0.25, 0.25], dtype=object))<br>
2015-12-15 -- PRINT(&#39;Current context.n: &#39;, 5)<br>
2015-12-15 -- PRINT(&#39;Required Allocation: &#39;, array([0.25, 0.25, 0.25, 0.25], dtype=object))<br>
2015-12-22 -- PRINT(&#39;Current context.n: &#39;, 5)<br>
2015-12-22 -- PRINT(&#39;Required Allocation: &#39;, array([0.25, 0.25, 0.25, 0.25], dtype=object))<br>
2015-12-29 -- PRINT(&#39;Current context.n: &#39;, 4)  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56ce3839458dad4023000045' id='56ce3839458dad4023000045'>
<a href='#56ce3839458dad4023000045'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1456355390000' class='quanto-date posted-at response-posted-at' href='#56ce3839458dad4023000045'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><blockquote>
<p>could help walk me through what this portion of the code is doing?</p>
</blockquote>

<pre><code>   # set up the optimization  
   bnds = []  
    limits = [0,1]  
    for stock in context.stocks:  
        bnds.append(limits)  
    bnds = tuple(tuple(x) for x in bnds)

    cons = ({&#39;type&#39;: &#39;eq&#39;, &#39;fun&#39;: lambda x:  np.sum(x)-1.0},  
            {&#39;type&#39;: &#39;ineq&#39;, &#39;fun&#39;: lambda x:  np.dot(x,ret_norm)-context.eps})  
    # run the optimizer  
    res= scipy.optimize.minimize(variance, context.x0, args=ret,jac=jac_variance, method=&#39;SLSQP&#39;,constraints=cons,bounds=bnds) 

    # determine the allocation  
    if res.success:  
        allocation = res.x  
        allocation[allocation&lt;0] = 0  # clip off any negative terms  
        denom = np.sum(allocation)  
        if denom &gt; 0 and np.dot(allocation,ret_norm) &gt;= 0:  
            allocation = allocation/denom  
    else:  
        allocation = np.copy(context.x0) 

    # keep track of the number of times run &amp; a running sum of the allocations (so the average can be computed)  
    context.n += 1  
    context.s += allocation  
</code></pre>

<p>As noted above, the idea is to accumulate allocations over some period of time, and then average them.  However, you&#39;ll get the same array if the allocation is always the same, regardless of n.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='56dc793e73b2d51b9d000119' id='56dc793e73b2d51b9d000119'>
<a href='#56dc793e73b2d51b9d000119'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1457289545000' class='quanto-date posted-at response-posted-at' href='#56dc793e73b2d51b9d000119'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Here&#39;s a first crack at a long-short version.  Maybe someone has insights into improving it.  Note that I switched to SPY, thinking that it would be subject to less slippage than RSP at higher capital.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='57212116147e8c84fe00007d' id='57212116147e8c84fe00007d'>
<a href='#57212116147e8c84fe00007d'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/56ee9f14e83991387a00061d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/68079e45d8f14ef792af97f97a919748?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/56ee9f14e83991387a00061d'>Francesco Cricchio</a>
</div>
<a UTCms='1461788959000' class='quanto-date posted-at response-posted-at' href='#57212116147e8c84fe00007d'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Hi guys, is there a version of this min variance strategy that is applicable to a long-short strategy or the fact that the weights are all positive should be considered as a constraint ?  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5721cadf147e8c84fe00076e' id='5721cadf147e8c84fe00076e'>
<a href='#5721cadf147e8c84fe00076e'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1461832424000' class='quanto-date posted-at response-posted-at' href='#5721cadf147e8c84fe00076e'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Francesco,</p>

<p>Here&#39;s basically the version I posted above (Mar. 6, 2016), but brought up to Q2 standards.  It supports both long and short positions.</p>

<p>Grant  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='57222135657a989bfa000ad5' id='57222135657a989bfa000ad5'>
<a href='#57222135657a989bfa000ad5'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/56ee9f14e83991387a00061d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/68079e45d8f14ef792af97f97a919748?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/56ee9f14e83991387a00061d'>Francesco Cricchio</a>
</div>
<a UTCms='1461854529000' class='quanto-date posted-at response-posted-at' href='#57222135657a989bfa000ad5'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks a lot Grant for the useful answer!<br>
As alternative, do you think that it could make sense also to calculate the weights of the long and short positions in independet manner by then minimizing the variance of returns of short and long separately?<br>
Cheers<br>
Francesco  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='572255afa1229e41b1000e29' id='572255afa1229e41b1000e29'>
<a href='#572255afa1229e41b1000e29'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/56ee9f14e83991387a00061d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/68079e45d8f14ef792af97f97a919748?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/56ee9f14e83991387a00061d'>Francesco Cricchio</a>
</div>
<a UTCms='1461867956000' class='quanto-date posted-at response-posted-at' href='#572255afa1229e41b1000e29'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Dear Grant,<br>
just another question, is still correct the calculation of the returns on a portfolio that also includes both long and short positions as  </p>

<pre><code>ret = prices.pct_change()[1:].as_matrix(context.stocks)  
</code></pre>

<p>shouldn&#39;t this ok only for long positions?<br>
Thanks again<br>
Francesco  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='57228f040865ee676a000199' id='57228f040865ee676a000199'>
<a href='#57228f040865ee676a000199'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1461882633000' class='quanto-date posted-at response-posted-at' href='#57228f040865ee676a000199'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>I think that the minimization of the variance works using the returns as written.  The constraints are what determine whether it is long only, or if long and short are allowed.  The first one is normalization of the weights, allowing both positive and negative.  The second one, I think, is a kind of long-short mean reversion constraint, but I gotta dwell on that one a bit.</p>

<pre><code>  cons = ({&#39;type&#39;: &#39;eq&#39;, &#39;fun&#39;: lambda x:  np.sum(np.absolute(x))-1.0},  
            {&#39;type&#39;: &#39;ineq&#39;, &#39;fun&#39;: lambda x:  np.dot(x,ret_norm)-context.eps})  
</code></pre>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='57228f05b586294c770007c5' id='57228f05b586294c770007c5'>
<a href='#57228f05b586294c770007c5'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1461882643000' class='quanto-date posted-at response-posted-at' href='#57228f05b586294c770007c5'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>I think that the minimization of the variance works using the returns as written.  The constraints are what determine whether it is long only, or if long and short are allowed.  The first one is normalization of the weights, allowing both positive and negative.  The second one, I think, is a kind of long-short mean reversion constraint, but I gotta dwell on that one a bit.</p>

<pre><code>  cons = ({&#39;type&#39;: &#39;eq&#39;, &#39;fun&#39;: lambda x:  np.sum(np.absolute(x))-1.0},  
            {&#39;type&#39;: &#39;ineq&#39;, &#39;fun&#39;: lambda x:  np.dot(x,ret_norm)-context.eps})  
</code></pre>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5724a165cb2b81e469000727' id='5724a165cb2b81e469000727'>
<a href='#5724a165cb2b81e469000727'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1462018409000' class='quanto-date posted-at response-posted-at' href='#5724a165cb2b81e469000727'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>What do you mean &quot;breaks down&quot; - times out, runs out of memory, other error, poor financial performance?  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5724a2086ac98b15ec0006ee' id='5724a2086ac98b15ec0006ee'>
<a href='#5724a2086ac98b15ec0006ee'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1462018582000' class='quanto-date posted-at response-posted-at' href='#5724a2086ac98b15ec0006ee'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>By the way, you can drop the call to handle_data if it does nothing.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5724ade0a075f9145400075b' id='5724ade0a075f9145400075b'>
<a href='#5724ade0a075f9145400075b'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/56ee9f14e83991387a00061d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/68079e45d8f14ef792af97f97a919748?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/56ee9f14e83991387a00061d'>Francesco Cricchio</a>
</div>
<a UTCms='1462021605000' class='quanto-date posted-at response-posted-at' href='#5724ade0a075f9145400075b'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>if you put N=20 for exampe in attached backtest code at line 30  </p>

<p>then at line  223</p>

<pre><code> if res.success and denom &gt; 0:  
        allocation = allocation/denom  
    else:  
        print &#39;failed min&#39;  
        allocation = np.copy(context.x0)  
</code></pre>

<p>the minimization function fails for all steps  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5724b6eb6ee76e799b000748' id='5724b6eb6ee76e799b000748'>
<a href='#5724b6eb6ee76e799b000748'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1462023922000' class='quanto-date posted-at response-posted-at' href='#5724b6eb6ee76e799b000748'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Got it to work for N = 50.  Once the backtest completes, I&#39;ll post it.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5724bc08008241a181000024' id='5724bc08008241a181000024'>
<a href='#5724bc08008241a181000024'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1462025228000' class='quanto-date posted-at response-posted-at' href='#5724bc08008241a181000024'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>I changed to:</p>

<pre><code>N_STOCKS = 50  
context.eps = 1  
</code></pre>

<p>Can&#39;t say that I understand it at this point, but there is an interaction between the two settings.  I may have the time to take another look later today.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5724d628f9812879430000ba' id='5724d628f9812879430000ba'>
<a href='#5724d628f9812879430000ba'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/56ee9f14e83991387a00061d'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/68079e45d8f14ef792af97f97a919748?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/56ee9f14e83991387a00061d'>Francesco Cricchio</a>
</div>
<a UTCms='1462031918000' class='quanto-date posted-at response-posted-at' href='#5724d628f9812879430000ba'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Ok, thanks<br>
for N=100, I noticed it is required eps=10 to make it work, backtest attached  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5724d7b7b8c7b4fb640000dc' id='5724d7b7b8c7b4fb640000dc'>
<a href='#5724d7b7b8c7b4fb640000dc'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1462032323000' class='quanto-date posted-at response-posted-at' href='#5724d7b7b8c7b4fb640000dc'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>I&#39;d suggest &quot;rolling your own&quot; versus trying to piggy-back off of my code (it is just a hack job).  One thought is to do the long-short filtering/ranking thing, showing that you can get some decent performance, and then maybe trying some sort of minimum variance optimization, to see if the Sharpe ratio could be improved.  Note that CVXOPT is also available as an optimizer.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='572513feb82b3ba029000242' id='572513feb82b3ba029000242'>
<a href='#572513feb82b3ba029000242'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/56b00aea4339666f650001cb'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/5d8f88a1960d4cd79d20b17a2631df1e?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/56b00aea4339666f650001cb'>Peter Falter</a>
</div>
<a UTCms='1462047748000' class='quanto-date posted-at response-posted-at' href='#572513feb82b3ba029000242'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Hello Grant, et al:<br>
An algorithm that is simple, trades weekly, and achieves Sharpe &gt; 2, deserves some consideration.<br>
In playing with Grant&#39;s algo I noticed some odd behavior and took some effort to investigate.</p>

<p>My backtest file contains additional comments.</p>

<p><strong>Observations</strong><br>
    1. The algorithm is novel in how returns are calculated from minute data over a five day span. This overcomes a problem with the use of daily data. For robust covariance you want to use a number of periods that is at least 10x the number of equities. Four equities implies 40 days of data. Such a long window is a problem when trying to characterize an erratic equity like VIX or a commodity.<br>
    2. Total return for selected equities (RSP, EDV, TLT, XIV) and eps (0.05) is superb over the period 1 Dec 2010 to 4 Feb 2016<br>
    3. Total return is very sensitive to eps<br>
        288% @ eps = 0.049<br>
        362% @ eps = 0.050<br>
        219% @ eps = 0.051<br>
    4. Total return changes drastically with substitution of similar equities<br>
        (SPY for RSP)   235% vs 362%<br>
        (TLO for TLT)   197% vs 362%<br>
    5. The total return is very sensitive to the number of days of look back (separate backtest showed more than 3-to-1 variation in Sharpe ratio for lookback periods of 3 to 20 days). Similarly the result was very sensitive to start/end dates.<br>
    6. Something is wrong for such sensitivity in the result.</p>

<p><strong>Compliance with the inequality constraint</strong><br>
For Grant&#39;s version of the algo and the case of eps=0.05 the inequality constraint is only met 49 out of 1303 days<br>
This means that the algo is coasting the prior solution most of the time and is not operating as intended.<br>
As you might expect is such a case the result is very sensitive to parameter or equity changes.<br>
If the &quot;success&quot; logic is corrected the actual return is 101%, which is better than SPY, but with much higher volatility and drawdown</p>

<p><strong>Why is this happening?</strong><br>
The ret_norm values are typically smaller than 0.05 and are often negative.<br>
This means that on most days no set of positive weights summing to 1.0 can be found that will satisfy the constraint: dot(weights,ret_norm) &gt; eps</p>

<p><strong>But the algo checks for res.success</strong><br>
Yes, it does.<br>
I don&#39;t understand the scipy SLSQP implementation well enough to say why res.success is True when res.status is not 0<br>
Grant appears to be calling/invoking (what is the python term?) per the documentation<br>
The following res.status errors are commonly seen with large eps values:<br>
 4 : Inequality constraints incompatible<br>
 8 : Positive directional derivative for linesearch<br>
 9 : Iteration limit exceeded (this always appears on the first 4 days)</p>

<p><strong>So should I use a smaller eps value?</strong><br>
Generally yes, but not a fixed value<br>
In this particular algo the set of equities is small and there is no other mechanism to assure that ret_norm values above some threshold, or are even positive.<br>
Given this you face poor trade: reducing eps allows the algorithm to function as intended, but degrades performance as eps is the return threshold<br>
Some dynamic method for setting eps is needed for this algorithm.</p>

<p><strong>How to dynamically select eps</strong><br>
I welcome those of you with finance and math backgrounds to provide a more elegant solution, Here&#39;s a simple approach.<br>
Assume that Equity 1 has the highest of the four ret_norm values (ret_norm_max). If the weights are set so that all are zero except for Equity 1, then the portfolio&#39;s ret_norm = ret_norm_max. Since the number of equities is small it is possible that Equity 1 is the only one with ret_norm&gt;0. This condition frustrates optimization. A smaller eps value than ret_norm_max will improve the likelihood of optimization. As noted above a too small value will rob performance.<br>
Here are some results for eps = 85%, 90%, 95%, and 100% of ret_norm_max<br>
For each case the SLSQP optimizer succeeds in 1299 of 1303 days. It consistently fails to on the first 4 days.<br>
return = 189% @ 100%<br>
return = 239% @ 95%<br>
return = 243% @ 90%<br>
return = 232% @ 85%</p>

<p><strong>Comment</strong><br>
While the result is not as spectacular as it first appeared the algorithm is now functioning as I expected  and is more robust to parameter and equity changes. Now more investigation can be done (eps selection, equity selection, look back window, ...)  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='572652bd02dd621c5300018e' id='572652bd02dd621c5300018e'>
<a href='#572652bd02dd621c5300018e'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1462129352000' class='quanto-date posted-at response-posted-at' href='#572652bd02dd621c5300018e'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Thanks Peter,</p>

<p>Glad you found it interesting. </p>

<p>Cheers,</p>

<p>Grant  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58b1fa93dc70b7000da7cbc0' id='58b1fa93dc70b7000da7cbc0'>
<a href='#58b1fa93dc70b7000da7cbc0'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1488059027000' class='quanto-date posted-at response-posted-at' href='#58b1fa93dc70b7000da7cbc0'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Here&#39;s an update using CVXPY.  I think it is working basically in the same fashion as the original post above.  It has been re-factored a bit, and more could be done.  The main thing here is that CVXPY can be used.  --Grant</p>

<p>Note:</p>

<pre><code>    set_slippage(slippage.FixedSlippage(spread=0.00))  
    set_commission(commission.PerShare(cost=0, min_trade_cost=0))  
</code></pre>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58b20bbcc9a5da000afe8c16' id='58b20bbcc9a5da000afe8c16'>
<a href='#58b20bbcc9a5da000afe8c16'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/56009dbb05de07c08d0001e4'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/8bb6068727562bb488da5bbdecf32474?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/56009dbb05de07c08d0001e4'>Evan LaRiviere</a>
</div>
<a UTCms='1488063420000' class='quanto-date posted-at response-posted-at' href='#58b20bbcc9a5da000afe8c16'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Very cool Grant. What do limitations, if any, do you see with this algo?  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58b2d06334f430000d11508b' id='58b2d06334f430000d11508b'>
<a href='#58b2d06334f430000d11508b'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1488113763000' class='quanto-date posted-at response-posted-at' href='#58b2d06334f430000d11508b'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Hi Evan,</p>

<p>Well, first off, I just hacked the thing together, so <em>caveat investor</em>.  This is probably the biggest &quot;limitation&quot;--that it doesn&#39;t have a spelled out underlying economic principle (i.e. what makes the thing tick).  So, it could be &quot;over-fit&quot; and/or suffer from &quot;data mining&quot; (insert your favorite quant sin).  The problem is compounded by the limited time over which one can backtest.  If it could be tested going back many decades, then one could have more confidence.</p>

<p>The drawdown and volatility are very high, so another limitation, assuming that the long-term returns would persist, is that in the absence of a model explaining the returns, the likelihood of &quot;abandoning ship&quot; after losing money is high.  For example, say one puts money into it and then it immediately drops 20%.  It would be easy to justify pulling out, to cut losses.</p>

<p>It would be nice to see beta much lower (e.g. in the range -0.3 to 0.3, as Q requires for the contest), without shorting.  With such a high beta, maybe there is a risk that if the market tanks, the strategy would die, too?  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58b2dd6334f430000a115175' id='58b2dd6334f430000a115175'>
<a href='#58b2dd6334f430000a115175'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/52b0e0e0271a27fc88000049'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/e5451406e743420c700eb2b054b2fc57?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/52b0e0e0271a27fc88000049'>Blue Seahawk</a>
</div>
<a UTCms='1488117091000' class='quanto-date posted-at response-posted-at' href='#58b2dd6334f430000a115175'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Leverage 1.29 intraday. Try this: Before ordering, determine whether the order will be an increase or decrease in allocation. Since there is no shorting in this case those are buy and sell respectively. Hold buys until selling is done. That will resolve the 57k negative cash and typically result in a higher return from what I&#39;ve seen. Here, returns show 365% however margin was discarded so it made 366k on 157k for 232%. Benchmark 117%. It may do higher than 365%, real with no negative cash given those changes. There&#39;s an example of it above.</p>

<pre><code>2017-02-24 13:00 _pvr:155 INFO PvR 0.1483 %/day   cagr 0.3   Portfolio value 466017   PnL 366017  
2017-02-24 13:00 _pvr:156 INFO   Profited 366017 on 157790 activated/transacted for PvR of 232.0%  
2017-02-24 13:00 _pvr:157 INFO   QRet 366.02 PvR 231.96 CshLw -57790 MxLv 1.29 RskHi 157790 MxShrt 0  
2017-02-24 13:00 pvr:245 INFO 2010-12-08 to 2017-02-24  $100000  2017-02-26 08:23 US/Eastern  
Runtime 0 hr 12.9 min  
</code></pre>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58b2e118e70bbf000af0fe94' id='58b2e118e70bbf000af0fe94'>
<a href='#58b2e118e70bbf000af0fe94'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1488118040000' class='quanto-date posted-at response-posted-at' href='#58b2e118e70bbf000af0fe94'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>A quickie example to illustrate that there may be ways to &quot;tame&quot; the algo to be kinda market neutral without shorting.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58b33e7ae70bbf000af10345' id='58b33e7ae70bbf000af10345'>
<a href='#58b33e7ae70bbf000af10345'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/52b0e0e0271a27fc88000049'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/e5451406e743420c700eb2b054b2fc57?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/52b0e0e0271a27fc88000049'>Blue Seahawk</a>
</div>
<a UTCms='1488141946000' class='quanto-date posted-at response-posted-at' href='#58b33e7ae70bbf000af10345'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Chart says it used 100k to make 152k, 152%.<br>
In reality it used 144k to make 152k, that&#39;s 105%, under the benchmark 117%.</p>

<p>That&#39;s the good news. With default slippage/commissions:<br>
Uses 196k to make 146k, just 75%. Better to invest in SPY.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58b340e05c6cf319bbcc003c' id='58b340e05c6cf319bbcc003c'>
<a href='#58b340e05c6cf319bbcc003c'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1488142560000' class='quanto-date posted-at response-posted-at' href='#58b340e05c6cf319bbcc003c'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Regarding commissions, my thought is that they would be $0 under Robinhood, right?</p>

<p>I guess you are concerned with leverage &gt; 1 temporarily.  Not sure how to handle that one.  My assumption is that Robinhood can handle re-balancing, but if it means that cash has to be kept in reserve, then, yes, it will hurt the return.</p>

<p>As for slippage, for small amounts of capital it can be neglected, but maybe that&#39;s incorrect?  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58b371a1f55480000af304b0' id='58b371a1f55480000af304b0'>
<a href='#58b371a1f55480000af304b0'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/52b0e0e0271a27fc88000049'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/e5451406e743420c700eb2b054b2fc57?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/52b0e0e0271a27fc88000049'>Blue Seahawk</a>
</div>
<a UTCms='1488155041000' class='quanto-date posted-at response-posted-at' href='#58b371a1f55480000af304b0'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>With zero commission and default slippage:<br>
Uses 197k to make 150k, that&#39;s 76%.<br>
Q Returns show 150%.</p>

<p>So slippage played the major role.</p>

<p>By the way I wish we had set_nonmargin() to be able to model what would happen on Robinhood or any nonmargin account.</p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58b403fe599b4833f21b7ec6' id='58b403fe599b4833f21b7ec6'>
<a href='#58b403fe599b4833f21b7ec6'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1488192510000' class='quanto-date posted-at response-posted-at' href='#58b403fe599b4833f21b7ec6'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>@ Blue -</p>

<p>Even better than 
<code>set_nonmargin()</code> would be something like <code>set_nonmargin(broker=`Robinhood`)</code> with any idiosyncrasies baked in, so that backtesting and Q paper trading would be 1:1 with real-money trading.  Robinhood, though, seems to have dropped off the radar screen at Quantopian headquarters.  It&#39;s all about the Q fund (and futures in private alpha).  Maybe a user has written an add-on like your proposed <code>set_nonmargin()</code>?  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58c705deab53a24e138bfa79' id='58c705deab53a24e138bfa79'>
<a href='#58c705deab53a24e138bfa79'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/56ce2ac976723c6809000123'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/fa18e2ab7dca80db308159c95d41c365?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/56ce2ac976723c6809000123'>yogi shibuya</a>
</div>
<a UTCms='1489438174000' class='quanto-date posted-at response-posted-at' href='#58c705deab53a24e138bfa79'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Hello guys,<br>
Great work! Quick question...is this algo safe for smaller accounts (less than $25,000). Will it trigger the &quot;Pattern Day trader&quot; rule (by executing four roundtrip daytrades within 5 days)? </p>

<p>Thanks!  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58c72a035d9d112690d27da6' id='58c72a035d9d112690d27da6'>
<a href='#58c72a035d9d112690d27da6'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1489447427000' class='quanto-date posted-at response-posted-at' href='#58c72a035d9d112690d27da6'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>A weekly re-balancing should be o.k., however I&#39;ve been advised that one has to watch out for going into negative cash.  See <a href="https://www.quantopian.com/posts/quantopian-and-robinhood-lessons-learned-and-best-practices">https://www.quantopian.com/posts/quantopian-and-robinhood-lessons-learned-and-best-practices</a> for some good info.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58cef39fa2ff5b477b28f3d8' id='58cef39fa2ff5b477b28f3d8'>
<a href='#58cef39fa2ff5b477b28f3d8'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/58715175d739e95500ac4fca'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/26d0d584d35e41049fa95cdeb51a6c2b?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/58715175d739e95500ac4fca'>Stephen Kearney</a>
</div>
<a UTCms='1489957791000' class='quanto-date posted-at response-posted-at' href='#58cef39fa2ff5b477b28f3d8'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Grant,</p>

<p>I&#39;m very interested in your implementation of the optimizer to find allocations.  Is there a paper or article you can point me to for background?  I&#39;d like to understand the strategy better.</p>

<p>TIA.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='58cfa0dc458fbb144a12bb88' id='58cfa0dc458fbb144a12bb88'>
<a href='#58cfa0dc458fbb144a12bb88'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/4f005d1b5e32ee000b000001'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/03ce2b05f15809a7239dc5910a54abf5?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/4f005d1b5e32ee000b000001'>Grant Kiehne</a>
</div>
<a UTCms='1490002140000' class='quanto-date posted-at response-posted-at' href='#58cfa0dc458fbb144a12bb88'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Hi Stephen -</p>

<p>I am not aware of a paper or article describing exactly what I&#39;ve done (a hack, really), but you might try Google Scholar.  The basic idea is to minimize the variance in returns with constraints.  I would be surprised if nobody has ever published something on the topic.</p>

<p>If you find anything, please share the references.</p>

<p>There is some general discussion on the use of optimizers in Robert Carver&#39;s book, <em>Systematic Trading</em>, along with using trailing volatility for weighting.  </p>
</div>
</div>
</div>

<div class='post-container response-container' data-post-id='5917aa362bde310010f22208' id='5917aa362bde310010f22208'>
<a href='#5917aa362bde310010f22208'></a>
<div class='post-metadata'>
<div class='row'>
<div class='col-xs-14'>
<div class='inline-block'>
<div class='avatar-container'>
<a href='/users/591494829496bb000d87ff75'><img class='avatar async-image' data-src='https://secure.gravatar.com/avatar/fda107f804051c235a93ce5195749d80?d=https%3A%2F%2Fs3.amazonaws.com%2Fquantopian-website-assets%2Fdefault-avatar.png' height='30' width='30'></a>
</div>
<a class='author-name' href='/users/591494829496bb000d87ff75'>MA K</a>
</div>
<a UTCms='1494723126000' class='quanto-date posted-at response-posted-at' href='#5917aa362bde310010f22208'></a>
</div>
</div>
</div>

<div class='response-text'>
<div class='response-text-container post-body'><p>Hi,</p>

<p>Really interesting stuff here. Question: according to scipy docs on the minimze function being employed here:</p>

<p>&quot;Note that COBYLA only supports inequality constraints.&quot;
<a href="https://docs.scipy.org/doc/scipy-0.19.0/reference/generated/scipy.optimize.minimize.html">https://docs.scipy.org/doc/scipy-0.19.0/reference/generated/scipy.optimize.minimize.html</a></p>

<p>But in the code, inequality is being used, and the method specified is SLSQP. Does this mean that this constraint is not actually being used? Or that the COBYLA method is in fact being used?</p>

<pre><code>cons = ({&#39;type&#39;: &#39;eq&#39;, &#39;fun&#39;: lambda x:  np.sum(x)-1.0},  
            {&#39;type&#39;: &#39;ineq&#39;, &#39;fun&#39;: lambda x:  np.dot(x,ret_norm)-context.eps})  
    res= scipy.optimize.minimize(variance, context.x1, args=ret,jac=jac_variance, method=&#39;SLSQP&#39;,constraints=cons,bounds=bnds)  
</code></pre>
</div>
</div>
</div>

</div>
<div class='sign-in-please'>
Please <a href='/signin?return_to=/posts/minimum-variance-w-slash-constraint'>sign in</a> or
<a href='/users/sign_up?redirect_to=/posts/minimum-variance-w-slash-constraint'>join Quantopian</a> to
post a reply.
</div>
</div>
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId: "550580758292093",
      status: false,
      cookie: true,
      xfbml: true
    });
  };
  
  (function(d, debug){
    var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement('script'); js.id = id; js.async = true;
    js.src = "//connect.facebook.net/en_US/all" + (debug ? "/debug" : "") + ".js";
    ref.parentNode.insertBefore(js, ref);
  }(document, /*debug*/ false));
  
  window.twttr = (function (d,s,id) {
    var t, js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return; js=d.createElement(s); js.id=id;
    js.src="//platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs);
    return window.twttr || (t = { _e: [], ready: function(f){ t._e.push(f) } });
  }(document, "script", "twitter-wjs"));
</script>
<script>
  $(document).ready(function () {
    quanto.instances.pm = new quanto.PostManager(false)
  });
</script>

<div class='login-footer'>
<div class='container'>
<div class='login-footer-text'>
Become an expert in quant finance through Quantopian's hands-on education.
</div>
<div class='login-footer-button'>
<button class='btn btn-v2 stroke join-modal-link mixpanel-button' data-event='anon join footer click posts' data-mixpanel='click'>
Join Now
</button>
</div>
</div>
</div>

<div class='fade modal quanto-modal-v2' id='error-modal' role='dialog' tabindex='-1'>
<div class='modal-dialog' role='document'>
<div class='modal-content'>
<div class='modal-header'>
<span class='title modal-title'>Error</span>
</div>
<div class='modal-body body-content'>
<p>Sorry, something went wrong.  Try again or contact us by <a class='feedback-link'>sending feedback</a>.</p>
</div>
<div class='modal-footer'>
<button class='btn btn-v2 blue action-button' data-dismiss='modal' href='#'>Close</button>
</div>

</div>
</div>
</div>

<div class='fade modal quanto-modal-v2' id='confirmation-modal' role='dialog' tabindex='-1'>
<div class='modal-dialog' role='document'>
<div class='modal-content'>
<div class='modal-header'>
<span class='title modal-title'></span>
</div>
<div class='modal-body body-content'></div>
<div class='modal-footer'>
<div class='pull-right'>
<button class='btn btn-v2 border' data-dismiss='modal'>Cancel</button>
<button class='btn btn-v2 blue action-button' data-dismiss='modal'></button>
</div>
</div>

</div>
</div>
</div>

<div class='fade modal quanto-modal-v2' id='message-modal' role='dialog' tabindex='-1'>
<div class='modal-dialog' role='document'>
<div class='modal-content'>
<div class='modal-header'>
<span class='title modal-title'></span>
</div>
<div class='modal-body body-content'></div>
<div class='modal-footer'>
<button class='btn btn-v2 blue action-button' data-dismiss='modal' id='message-modal-close'>Close</button>
</div>

</div>
</div>
</div>

<div class='always-bootstrap3-modals'>
<div class='fade modal quanto-modal-v2' id='join-modal' role='dialog' tabindex='-1'>
<div class='modal-dialog' role='document'>
<div class='modal-content'>
<div class='modal-header visible-small'>
<span class='title'>
Join Quantopian.  It's Free!
</span>
<div class='modal-x-out visible-xs'></div>
</div>
<div class='modal-body'>
<div class='flex-wrap'>
<div class='join-left-pane hidden-small'>
<div class='margin_30l'>
<div class='join-hero-text'>
Join Quantopian.  It's Free!
</div>
<div class='join-benefits'>
<div class='join-benefit'>
<div class='join-image-container'>
<div class='join-image code'></div>
</div>
<div class='join-text'>
Use our research platform, backtester, and dozens of clean data sets.
</div>
</div>
<div class='join-benefit'>
<div class='join-image-container'>
<div class='join-image learn'></div>
</div>
<div class='join-text'>
Learn with our hands-on education and community forums.
</div>
</div>
<div class='join-benefit'>
<div class='join-image-container'>
<div class='join-image win'></div>
</div>
<div class='join-text'>
Enter to win cash prizes in our contest.
</div>
</div>
</div>
<div class='hidden saved-reminder'>
Don't worry, all your work is already saved.
</div>
</div>
</div>
<div class='join-right-pane'>
<div class='hidden-small'>
<div class='button-pane'>
<a class="button btn-v2 user-form-btn" href="/signin">Already a Quantopian member?</a>
</div>
</div>
<div class='visible-small'>
<div class='already-member'>
<a href='/signin'>Already a Quantopian member?</a>
</div>
</div>
<form class="quanto-form-v2" id="new-user-modal-form" action="/users" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><div class='error-message hidden'>
<div class='message'></div>
</div>
<div class='name-group'>
<div class='form-group inline-block'>
<label for="user_firstname">First Name</label>
<input class="form-control firstname" pattern=".*" required="required" autocomplete="off" autofocus="autofocus" type="text" name="user[firstname]" id="user_firstname" />
</div>
<div class='form-group inline-block'>
<label for="user_lastname">Last Name</label>
<input class="form-control" value="" pattern=".*" required="required" autocomplete="off" type="text" name="user[lastname]" id="user_lastname" />
</div>
</div>
<div class='form-group'>
<label for="user_email">Email</label>
<input class="form-control" value="" pattern=".*" required="required" autocomplete="off" type="email" name="user[email]" id="user_email" />
</div>
<div class='form-group'>
<label for="user_password">Password</label>
<input autocomplete="off" class="form-control" pattern=".*" required="required" type="password" name="user[password]" id="user_password" />
</div>
<div class='checkbox eula'>
<input id='eula-checkbox' type='checkbox'>
<div class='quanto-checkbox'></div>
<label for='eula-checkbox' id='checkbox-label'>I accept the <a href='/policies/terms' target='_blank'>Terms Of Use</a> and <a href='/policies/privacy' target='_blank'>Privacy Policy</a>.</label>
</div>
<div class='checkbox mailchimp-box'>
<input name="user[allow_marketing_emails]" type="hidden" value="0" /><input type="checkbox" value="1" name="user[allow_marketing_emails]" id="user_allow_marketing_emails" />
<div class='quanto-checkbox'></div>
<label for='user_allow_marketing_emails'>
Send me email updates with the latest news from the Quantopian community. We send these emails about once a month.
</label>
</div>
<div class='button-row'>
<button class='btn-v2 blue full' data-redirect-to='/tutorials/getting-started' id='sign-up-button' type='Submit'>Join Quantopian</button>
</div>
</form></div>
</div>
</div>

</div>
</div>
</div>

<div class='fade modal quanto-modal-v2' id='feedback-modal' role='dialog' tabindex='-1'>
<div class='modal-dialog' role='document'>
<div class='modal-content'>
<div class='modal-header'>
<span class='title'>Contact Support</span>
</div>
<div class='modal-body'>
<form class='anon-user controls quanto-form-v2' id='feedback-form'>
<div class='feedback-inputs'>
<div class='form-group'>
<input autofocus class='form-control' id='feedback-email-box' name='email' placeholder='Email Address' type='email'>
</div>
<div class='form-group'>
<input class='form-control' id='feedback-name-box' placeholder='Name' type='name'>
</div>
<div class='form-group'>
<textarea class='form-control' id='feedback-box' name='feedback' placeholder='What may we help you with?' rows='10'></textarea>
</div>
</div>
</form>
<form class='hidden quanto-form-v2 select-resource-area'>
<div class='select-step select-type-step'>
<div class='form-group'>
<select class='form-control select-resource-dropdown' title='Select the item you need help with'>
<option value='algorithm'>Algorithm</option>
<option value='backtest'>Backtest</option>
<option value='notebook'>Notebook</option>
</select>
</div>
</div>
<div class='select-step loading-area hidden'>
<div class='loading-text'>
Loading...
</div>
</div>
<div class='select-step empty-list-area hidden'>
<div class='back-button'>Go Back</div>
<div class='empty-text'>
No <span class='empty-list-resource-text'>algorithms</span> found
</div>
</div>
<div class='select-algo-area select-step hidden'>
<div class='back-button'>Go Back</div>
<table class='select-algo-table select-item-table'>
<thead>
<tr>
<th>
Algorithm
<span class='sort-icon'></span>
</th>
<th>
Last Modified
<span class='sort-icon'></span>
</th>
</tr>
</thead>
</table>
</div>
<div class='select-backtest-area select-step hidden'>
<div class='back-button'>Go Back</div>
<table class='select-backtest-table select-item-table'>
<thead>
<tr>
<th>
Backtest
<span class='sort-icon'></span>
</th>
<th>
Started At
<span class='sort-icon'></span>
</th>
<th>
Overall Return
<span class='sort-icon'></span>
</th>
<th>
Status
<span class='sort-icon'></span>
</th>
</tr>
</thead>
</table>
</div>
<div class='select-notebook-area select-step hidden'>
<div class='back-button'>Go Back</div>
<div class='subtitle select-cell-step'>
Choose a cell to use as the preview for this notebook:
</div>
<div class='iframe-wrapper'>
<iframe class='notebook-list-iframe slow-fade' src=''></iframe>
</div>
<div class='progress-area slow-fade in'>
<div class='progress-container'>
<div class='progress-title'>
<div class='quanto-loader gray'></div>
</div>
</div>
</div>
<div class='maintenance-area'>
<div class='error-container'>
<div class='row'>
<div class='col-md-14 msg-title h1'>
Sorry, research is currently undergoing maintenance.
</div>
</div>
<div class='row'>
<div class='col-md-14 msg-subtitle'>
Please check back shortly. If the maintenance period lasts longer than expected,
you can find updates on <a href='https://status.quantopian.com/'>status.quantopian.com</a>.
</div>
</div>

</div>
</div>
<div class='error-area'>
<div class='error-container'>
<div class='row'>
<div class='col-md-14 msg-title h1'>
Sorry, something went wrong on our end.
</div>
</div>
<div class='row'>
<div class='col-md-14 msg-subtitle'>
Please try again or contact <a class='open-feedback-link'>Quantopian support</a>.
</div>
</div>

</div>
</div>

</div>
<div class='selected-item-area select-step hidden'>
<div class='selected-item-group form-group'>
<div class='selected-item-control'>
<input class='disabled form-control selected-item-box' type='text'>
<span class='secure-icon icon'></span>
<button class='btn change change-primary-item-button change-selection-button new-btn transparent' type='button'>
<span class='refresh-icon icon'></span>
</button>
</div>
<div class='selected-backtest-control'>
<input class='disabled form-control selected-backtest-box' type='text'>
<span class='secure-icon icon'></span>
<button class='btn change-backtest-button change-selection-button new-btn transparent' type='button'>
<span class='refresh-icon icon'></span>
</button>
</div>
</div>
<div class='checkbox-group form-group'>
<div class='checkbox give-permission'>
<input class='give-permission-checkbox' id='feedback-give-permission-checkbox' type='checkbox'>
<div class='quanto-checkbox'></div>
<label for='feedback-give-permission-checkbox'>
I permit Quantopian to view <span class='item-type-text'>this algorithm,
backtest or notebook and their imported datasets</span> for the purpose of providing support.
</label>
</div>
</div>
</div>
</form>

<div class='loading-step hidden'>
<div class='loading-text'>
Submitting your support ticket...
</div>
</div>
<div class='success-step invisible'>
<h2 class='title center'>
You've successfully submitted a support ticket.
</h2>
<p>
Our support team will be in touch soon.
</p>
<div class='confirmation-image'></div>
</div>
</div>
<div class='modal-footer'>
<button class='btn-v2 blue' id='send-feedback-button'>Send</button>
<div class='error-message hidden'>
Error submitting support request.
</div>
</div>

</div>
</div>
</div>

</div>
</div>
<div class='footer' id='quanto-footer-container'>
<div class='container'>
<div class='row header-row'>
<div class='col-sm-fourth span3'>
<img class='async-image logotype-image' data-src='https://qf.quantopian.com/assets/logos/logo-q-full-b23bda5ac757691b9259d396d0dfef91567165868b8c955a836649686e6d2248.svg'>
</div>
<div class='col-sm-fourth span3'></div>
<div class='col-sm-fourth span3'></div>
<div class='col-sm-fourth span3'>
<div class='feedback-email'>
Need help?
<a href="/cdn-cgi/l/email-protection#fa9c9f9f9e989b9991ba8b8f9b948e958a939b94d4999597">Contact support.</a>
</div>
</div>
</div>
<div class='row'>
<div class='col-sm-fourth span3'>
<div class='header'>Company</div>
<div class='footer-row'>
<a href='/about'>About</a>
</div>
<div class='footer-row'>
<a href='/academia'>Academia</a>
</div>
<div class='footer-row'>
<a href='/jobs'>Careers</a>
</div>
<div class='footer-row'>
<a href='/posts'>Community</a>
</div>
<div class='footer-row'>
<a href='/events'>Events</a>
</div>
</div>
<div class='col-sm-fourth span3'>
<div class='header'>Learn &amp; Support</div>
<div class='footer-row'>
<a href='/faq'>FAQ</a>
</div>
<div class='footer-row'>
<a href='/tutorials/getting-started'>Getting Started</a>
</div>
<div class='footer-row'>
<a href='/docs'>Documentation</a>
</div>
<div class='footer-row'>
<a href='/tutorials'>Tutorials</a>
</div>
<div class='footer-row'>
<a href='/lectures'>Lectures</a>
</div>
<div class='footer-row'>
<a href='/opensource'>Open Source</a>
</div>
<div class='footer-row'>
<a href='https://status.quantopian.com/'>Site Status</a>
</div>
</div>
<div class='col-sm-fourth span3'>
<div class='header'>Notices</div>
<div class='footer-row'>
<a href='/policies/terms'>Terms of Use</a>
</div>
<div class='footer-row'>
<a href='/policies/privacy'>Privacy Policy</a>
</div>
<div class='footer-row'>
<a href='/security'>Security</a>
</div>
<div class='footer-row'>
<a href='/policies/code-of-conduct'>Code of Conduct</a>
</div>
</div>
<div class='col-sm-fourth span3'>
<div class='header'>Follow Us</div>
<div class='footer-row'>
<a href='https://www.twitter.com/quantopian'>Twitter</a>
</div>
<div class='footer-row'>
<a href='https://www.facebook.com/quantopian'>Facebook</a>
</div>
<div class='footer-row'>
<a href='https://www.linkedin.com/company/quantopian'>LinkedIn</a>
</div>
<div class='footer-row'>
<a href='https://www.youtube.com/channel/UC606MUq45P3zFLa4VGKbxsg'>YouTube</a>
</div>
</div>
</div>
<div class='row'>
<div class='col-xs-14 span12'>
<div class='disclaimer'>
<p>
The material on this website is provided for informational purposes only and does not constitute an offer to sell, a solicitation to buy, or a recommendation or endorsement for any security or strategy, nor does it constitute an offer to provide investment advisory services by Quantopian.
</p>
<p>
In addition, the material offers no opinion with respect to the suitability of any security or specific investment. No information contained herein should be regarded as a suggestion to engage in or refrain from any investment-related course of action as none of Quantopian nor any of its affiliates is undertaking to provide investment advice, act as an adviser to any plan or entity subject to the Employee Retirement Income Security Act of 1974, as amended, individual retirement account or individual retirement annuity, or give advice in a fiduciary capacity with respect to the materials presented herein.  If you are an individual retirement or other investor, contact your financial advisor or other fiduciary unrelated to Quantopian about whether any given investment idea, strategy, product or service described herein may be appropriate for your circumstances.  All investments involve risk, including loss of principal.  Quantopian makes no guarantees as to the accuracy or completeness of the views expressed in the website. The views are subject to change, and may have become unreliable for various reasons, including changes in market conditions or economic circumstances.
</p>

</div>
</div>
</div>
</div>
</div>
<div class='mobile-footer'>
<div class='mobile-nav-category main-links'>
<div class='mobile-nav-row-footer'>
<a href='/about'>About Quantopian</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/jobs'>Careers</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/posts'>Community</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/events'>Events</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/docs'>Documentation</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/academia'>Academia</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/lectures'>Lectures</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='https://status.quantopian.com/'>Status</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='https://www.facebook.com/quantopian'>Facebook</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='https://www.twitter.com/quantopian'>Twitter</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='https://www.linkedin.com/company/quantopian'>LinkedIn</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='https://www.youtube.com/channel/UC606MUq45P3zFLa4VGKbxsg'>YouTube</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/policies/terms'>Terms of Use</a>
</div>
<div class='mobile-nav-row-footer'>
<a href='/policies/privacy'>Privacy Policy</a>
</div>
</div>
<div class='mobile-nav-category'>
<div class='disclaimer'>
<p>
The material on this website is provided for informational purposes only and does not constitute an offer to sell, a solicitation to buy, or a recommendation or endorsement for any security or strategy, nor does it constitute an offer to provide investment advisory services by Quantopian.
</p>
<p>
In addition, the material offers no opinion with respect to the suitability of any security or specific investment. No information contained herein should be regarded as a suggestion to engage in or refrain from any investment-related course of action as none of Quantopian nor any of its affiliates is undertaking to provide investment advice, act as an adviser to any plan or entity subject to the Employee Retirement Income Security Act of 1974, as amended, individual retirement account or individual retirement annuity, or give advice in a fiduciary capacity with respect to the materials presented herein.  If you are an individual retirement or other investor, contact your financial advisor or other fiduciary unrelated to Quantopian about whether any given investment idea, strategy, product or service described herein may be appropriate for your circumstances.  All investments involve risk, including loss of principal.  Quantopian makes no guarantees as to the accuracy or completeness of the views expressed in the website. The views are subject to change, and may have become unreliable for various reasons, including changes in market conditions or economic circumstances.
</p>

</div>
</div>
</div>

</div>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script></body>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', "UA-8519877-1", {
    cookieDomain: "quantopian.com"
  });
  ga('set', 'dimension1', 'session_5f9dc7425d387f00077e48e4');
  
  ga('send', 'pageview');
</script>

<input type="hidden" name="is_mac" id="is_mac" value="false" />
<input type="hidden" name="mp" id="mp" value="75873953cd404bcc1da88a55ff51e3b4" />
<script>
  (function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("75873953cd404bcc1da88a55ff51e3b4");
</script>
<script>
  mixpanel.track("view page", {"page": window.location.pathname});
</script>
</html>
